<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legend of Bahamut Strategy - Battle & Move Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

        body {
            font-family: 'DotGothic16', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            margin: 0;
            touch-action: manipulation;
        }

        .hex {
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            transition: all 0.2s;
        }

        .hex-active:hover {
            filter: brightness(1.5);
            cursor: pointer;
        }

        .scanline {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 100;
        }

        .pixel-border {
            border: 4px double #4a5568;
            background: rgba(0, 0, 0, 0.85);
        }

        @keyframes select-pulse {
            0% {
                filter: drop-shadow(0 0 5px cyan);
            }

            50% {
                filter: drop-shadow(0 0 20px cyan);
            }

            100% {
                filter: drop-shadow(0 0 5px cyan);
            }
        }

        .recruit-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="scanline"></div>

    <!-- VIEW: UI Elements -->
    <div id="ui-layer" class="fixed inset-0 z-50 pointer-events-none">

        <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº -->
        <div id="status-bar"
            class="absolute top-4 left-4 right-4 flex justify-between items-start hidden pointer-events-none">
            <div class="bg-black/70 p-4 border-2 border-gray-600 pointer-events-auto shadow-lg">
                <div class="text-xs text-gray-400 text-center uppercase mb-1 font-bold tracking-widest">Commander</div>
                <div id="master-name" class="text-2xl text-yellow-500 text-center font-bold"></div>
                <div id="master-alignment" class="text-sm text-center opacity-70 mt-1 text-white"></div>
            </div>

            <div class="flex flex-col gap-2 items-end">
                <div class="bg-black/70 p-4 border-2 border-gray-600 text-right pointer-events-auto shadow-lg">
                    <div class="flex gap-8 items-center">
                        <div class="text-right">
                            <div class="text-xs text-gray-400 uppercase font-bold text-blue-400">P-Castles</div>
                            <div id="castle-count-display" class="text-2xl text-blue-400 font-bold">1 / 7</div>
                        </div>
                        <div class="text-right border-l border-gray-600 pl-6">
                            <div class="text-xs text-gray-400 uppercase font-bold text-green-400">P-Armies</div>
                            <div id="army-total-display" class="text-2xl text-green-400 font-bold">1 / 8</div>
                        </div>
                        <div class="text-right border-l border-gray-600 pl-6">
                            <div class="text-xs text-gray-400 uppercase font-bold text-yellow-400">P-Gold</div>
                            <div id="gold-amount" class="text-4xl text-yellow-400 font-bold font-mono text-white">500
                            </div>
                        </div>
                        <div class="text-right border-l border-gray-600 pl-4 opacity-40">
                            <div class="text-[10px] text-red-400 uppercase font-bold">E-Gold</div>
                            <div id="enemy-gold-amount" class="text-xl text-red-400 font-bold font-mono text-white">500
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <div id="save-load-group" class="flex gap-3">
                        <button onclick="Controller.saveGame()"
                            class="px-6 py-2 bg-green-900 hover:bg-green-700 border-2 border-white text-lg font-bold pointer-events-auto transition-all shadow-xl text-white">„Çª„Éº„Éñ</button>
                        <button onclick="Controller.loadGame()"
                            class="px-6 py-2 bg-blue-900 hover:bg-blue-700 border-2 border-white text-lg font-bold pointer-events-auto transition-all shadow-xl text-white">„É≠„Éº„Éâ</button>
                    </div>
                    <button id="btn-end-strategic-turn" onclick="Controller.endStrategicTurn()"
                        class="px-10 py-3 bg-red-900 hover:bg-red-700 border-2 border-white text-2xl font-bold pointer-events-auto transition-all shadow-xl hidden">„Çø„Éº„É≥ÁµÇ‰∫Ü</button>
                </div>
            </div>
        </div>

        <!-- Âüé„É°„Éã„É•„Éº -->
        <div id="base-menu"
            class="absolute inset-0 bg-black/95 flex items-center justify-center hidden pointer-events-auto p-4 text-white">
            <div class="pixel-border p-8 w-full max-w-6xl max-h-[95vh] overflow-y-auto shadow-[0_0_50px_rgba(0,0,0,1)]">
                <div class="flex justify-between items-start mb-6 border-b border-gray-700 pb-6">
                    <div>
                        <h2 class="text-5xl text-yellow-500 font-bold mb-2" id="base-menu-title">Âüé„ÅÆÂêçÂâç</h2>
                        <div id="castle-stat-panel" class="flex gap-8 text-xl font-bold"></div>
                    </div>
                    <div class="flex flex-col items-end gap-4">
                        <div
                            class="flex items-center gap-4 bg-black/50 p-3 rounded border border-gray-700 shadow-inner">
                            <span class="text-gray-400 text-sm font-bold uppercase">Funds:</span>
                            <span class="text-3xl text-yellow-400 font-bold font-mono"
                                id="menu-gold-display">500G</span>
                        </div>
                        <div class="flex gap-3">
                            <button id="btn-create-army"
                                class="px-8 py-3 bg-purple-900 hover:bg-purple-700 border-2 border-purple-400 text-xl transition-colors disabled:opacity-30 disabled:grayscale font-bold shadow-xl">Êñ∞Ë¶èÈÉ®Èöä„ÇíÁ∑®Êàê
                                (500G)</button>
                            <button onclick="View.toggleBaseMenu()"
                                class="text-gray-400 hover:text-white transition-colors text-5xl p-2">‚úï</button>
                        </div>
                    </div>
                </div>
                <div id="unique-unit-info-panel"
                    class="mb-8 p-6 bg-yellow-900/30 border-2 border-yellow-700/50 rounded-xl flex items-center gap-8 hidden text-white">
                </div>
                <div id="base-menu-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8 text-white"></div>
                <div id="no-unit-message"
                    class="hidden py-24 text-center border-4 border-dashed border-gray-800 rounded-xl text-gray-500 text-2xl font-bold">
                    ÈßêÁïôÈÉ®Èöä„Å™„Åó</div>
            </div>
        </div>

        <!-- ÁµêÊûú„É¢„Éº„ÉÄ„É´ -->
        <div id="modal-layer"
            class="absolute inset-0 bg-black/80 flex items-center justify-center hidden pointer-events-auto text-white">
            <div class="bg-gray-900 border-4 border-double border-white p-12 max-w-lg w-full text-center shadow-2xl">
                <h2 id="modal-title" class="text-5xl font-bold mb-8 text-yellow-500 uppercase">Result</h2>
                <p id="modal-body" class="mb-12 text-2xl leading-relaxed text-gray-200 font-bold"></p>
                <div id="modal-footer" class="flex justify-center gap-8"></div>
            </div>
        </div>

        <!-- ÊúÄÂâçÈù¢„Å´Ë°®Á§∫„Åô„Åπ„ÅçË¶ÅÁ¥† -->
        <div id="top-elements" class="absolute inset-0 pointer-events-none">
            <!-- „Çø„Éº„É≥Ë°®Á§∫ -->
            <div id="turn-indicator"
                class="absolute top-4 left-1/2 -translate-x-1/2 px-12 py-2 bg-black/80 border-2 border-white hidden pointer-events-auto shadow-2xl flex flex-col items-center">
                <div id="turn-display" class="text-sm text-yellow-500 font-bold mb-1">TURN 1</div>
                <p id="turn-text" class="text-3xl font-bold tracking-widest text-center uppercase">Player Turn</p>
            </div>

            <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ -->
            <div id="message-box"
                class="absolute bottom-10 left-1/2 -translate-x-1/2 w-4/5 max-w-2xl bg-black/95 border-4 border-double border-gray-500 p-6 opacity-0 transition-opacity pointer-events-auto shadow-2xl">
                <p id="message-text"
                    class="text-xl md:text-2xl leading-relaxed whitespace-pre-wrap text-white font-bold text-center">
                </p>
            </div>
        </div>
    </div>

    <!-- „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
    <div id="screen-ending"
        class="hidden flex flex-col items-center justify-center h-screen bg-black text-white p-8 relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-blue-900/20 to-black pointer-events-none"></div>
        <div id="ending-vfx" class="absolute inset-0 pointer-events-none opacity-50"></div>

        <div class="relative z-10 text-center scale-110">
            <h2 id="ending-title"
                class="text-8xl font-bold mb-12 text-yellow-500 uppercase tracking-tighter drop-shadow-[0_0_30px_rgba(234,179,8,0.5)]">
                VICTORY</h2>
            <div class="pixel-border p-12 mb-16 max-w-3xl bg-black/60 shadow-2xl">
                <p id="ending-body" class="text-3xl leading-relaxed text-gray-200 font-bold"></p>
            </div>
            <button onclick="location.reload()"
                class="px-20 py-8 bg-gradient-to-r from-blue-900 to-blue-700 hover:from-blue-700 hover:to-blue-500 border-4 border-white transition-all text-4xl font-bold shadow-[0_0_50px_rgba(0,0,0,0.5)] hover:scale-105 active:translate-y-1">
                „Çø„Ç§„Éà„É´ÁîªÈù¢„Å∏Êàª„Çã
            </button>
        </div>
    </div>

    <!-- MAIN SCREENS -->
    <div id="screen-title" class="flex flex-col items-center justify-center h-screen relative">
        <h1
            class="text-8xl mb-8 font-bold text-transparent bg-clip-text bg-gradient-to-b from-gray-200 to-gray-600 uppercase tracking-tighter text-center">
            Bahamut Strategy</h1>
        <p class="mb-16 text-3xl text-gray-400 italic font-bold text-center">„Äú Â§ßÈô∏Áµ±‰∏ÄÔºöÊú¨Ê†º„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ „Äú</p>
        <div class="flex gap-4">
            <button onclick="Controller.showMasterSelection()"
                class="px-16 py-6 bg-red-900 hover:bg-red-700 border-2 border-white transition-all text-4xl font-bold shadow-2xl hover:scale-105 text-white">START
                GAME</button>
            <button onclick="Controller.loadGame()"
                class="px-16 py-6 bg-blue-900 hover:bg-blue-700 border-2 border-white transition-all text-4xl font-bold shadow-2xl hover:scale-105 text-white">LOAD
                GAME</button>
        </div>
        <button onclick="TestSuite.runAll()"
            class="absolute bottom-4 right-4 px-4 py-2 bg-gray-800 text-gray-500 text-xs hover:text-white border border-gray-700 pointer-events-auto transition-colors">Run
            System Tests</button>
    </div>

    <div id="screen-select" class="hidden flex-col items-center justify-center h-screen p-4 overflow-y-auto">
        <h2 class="text-5xl mb-16 font-bold text-center text-white">„Éû„Çπ„Çø„Éº„ÇíÈÅ∏Êäû„Åõ„Çà</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10 max-w-7xl w-full"></div>
    </div>

    <div id="screen-map" class="hidden relative h-screen bg-green-900/20">
        <canvas id="map-canvas" class="w-full h-full"></canvas>
    </div>

    <div id="screen-battle" class="hidden flex flex-col items-center justify-center h-screen bg-slate-900">
        <div class="mb-8 flex gap-16">
            <div id="p1-stats" class="text-4xl text-blue-400 font-bold uppercase tracking-wider">PLAYER</div>
            <div class="text-white text-2xl font-bold opacity-30 italic self-center">VS</div>
            <div id="p2-stats" class="text-4xl text-red-400 font-bold uppercase tracking-wider">ENEMY</div>
        </div>
        <div id="battle-grid" class="relative scale-110"></div>
        <div class="mt-16 flex gap-10">
            <button id="battle-end-turn-btn" onclick="Controller.battleEndTurnOrder()"
                class="px-12 py-4 bg-blue-800 hover:bg-blue-600 border-2 border-white transition-colors text-2xl font-bold rounded-lg shadow-xl pointer-events-auto text-white">„Çø„Éº„É≥ÁµÇ‰∫Ü</button>
            <button onclick="Controller.showEscapeConfirm()"
                class="px-12 py-4 bg-gray-800 hover:bg-gray-600 border-2 border-white transition-colors text-2xl font-bold rounded-lg shadow-xl pointer-events-auto text-white">Êí§ÈÄÄ</button>
        </div>
    </div>

    <script>
        /**
         * MODEL: ÂÆöÁæ©„Å®Áä∂ÊÖãÁÆ°ÁêÜ
         */
        const Model = {
            MAX_UNITS: 5,
            MAX_ARMIES: 8,
            ARMY_COST: 500,
            UNIT_SPEED: 10.0, // ÈÄ≤Ëªç„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó
            RANK_UP_XP: 50, // „É©„É≥„ÇØ„Ç¢„ÉÉ„Éó„Å´ÂøÖË¶Å„Å™ÁµåÈ®ìÂÄ§
            RANKS: ['E', 'D', 'C', 'B', 'A', 'S'],

            MASTERS: [
                { id: 'knight', name: '„Ç∏„Éº„ÇØ', alignment: 'LAW', color: '#4466ff', emoji: 'üè∞', desc: 'ËÅñÈ®éÂ£´„ÄÇÈò≤Âæ°„Å®ËøëÊé•Êà¶Èóò„Å´ÂÑ™„Çå„Çã„Éê„É©„É≥„ÇπÂûã„ÄÇ' },
                { id: 'mage', name: '„Ç¢„Éº„Ç∑„Çß', alignment: 'NEUTRAL', color: '#44ff66', emoji: 'üßù', desc: 'Â•≥Áéã„ÄÇÈÅ†Ë∑ùÈõ¢È≠îÊ≥ï„Å®Ê©üÂãïÂäõ„ÇíÊåÅ„Å§„Ç®„É´„ÉïËªç„ÄÇ' },
                { id: 'demon', name: '„ÇØ„É™„É†„Çæ„É≥', alignment: 'CHAOS', color: '#ff4444', emoji: 'üëπ', desc: 'È≠îÁéã„ÄÇÂúßÂÄíÁöÑ„Å™ÊîªÊíÉÂäõ„ÅßÊïµ„ÇíÁ≤âÁ†ï„Åô„Çã„ÄÇ' }
            ],

            FACTION_UNITS: {
                'knight': [
                    { id: 'soldier', name: 'ÂÖµÂ£´', emoji: 'üõ°Ô∏è', hp: 40, atk: 14, range: 1, move: 3, cost: 200 },
                    { id: 'paladin', name: 'È®éÂ£´', emoji: 'üèá', hp: 60, atk: 20, range: 1, move: 5, cost: 500 }
                ],
                'mage': [
                    { id: 'elf', name: '„Ç®„É´„Éï', emoji: 'üèπ', hp: 30, atk: 18, range: 3, move: 3, cost: 300 },
                    { id: 'fairy', name: 'Â¶ñÁ≤æ', emoji: 'üßö', hp: 25, atk: 12, range: 2, move: 4, cost: 250 }
                ],
                'demon': [
                    { id: 'imp', name: 'Â∞èÊÇ™È≠î', emoji: 'üëø', hp: 28, atk: 18, range: 1, move: 4, cost: 150 },
                    { id: 'dragon', name: 'Á´ú', emoji: 'üêâ', hp: 95, atk: 32, range: 1, move: 6, cost: 1000 }
                ]
            },

            SPECIAL_UNITS: {
                'hell-hound': { id: 'hell-hound', name: '„Ç±„É´„Éô„É≠„Çπ', emoji: 'üêï', hp: 45, atk: 22, range: 1, move: 5, cost: 600, origin: 'ÊöóÈªíÂüé' },
                'guard': { id: 'guard', name: 'ÈáçË£ÖË°õÂÖµ', emoji: 'üíÇ', hp: 80, atk: 18, range: 1, move: 2, cost: 400, origin: 'Ëá™Áî±ÈÉΩÂ∏Ç' },
                'crossbow': { id: 'crossbow', name: 'Âº©ÂÖµ', emoji: 'üèπ', hp: 35, atk: 22, range: 4, move: 2, cost: 550, origin: 'Âåó„ÅÆÁ†¶' },
                'militia': { id: 'militia', name: 'Áæ©ÂãáÂÖµ', emoji: 'üßë‚Äçüåæ', hp: 25, atk: 12, range: 1, move: 3, cost: 100, origin: 'Âçó„ÅÆÊùë' },
                'sorcerer': { id: 'sorcerer', name: 'È≠îÂ∞éÂ∏´', emoji: 'üßô', hp: 40, atk: 28, range: 3, move: 2, cost: 800, origin: 'Êù±„ÅÆÂ°î' },
                'ghost': { id: 'ghost', name: '‰∫°Èúä', emoji: 'üëª', hp: 25, atk: 22, range: 1, move: 6, cost: 350, origin: 'Ë•ø„ÅÆÂªÉÂ¢ü' }
            },

            state: {
                currentScreen: 'title',
                playerMaster: null, gold: 500, enemyGold: 500,
                mapUnits: [], castles: [], selectedMapUnit: null,
                strategicTurn: 'player', encounterEnemy: null, encounterPlayer: null,
                encounterCooldown: 0, gameCleared: false, turnCount: 0, enemyTurnStarted: false,
                battle: { active: false, grid: [], units: [], turn: 'player', selectedUnit: null, movedUnits: new Set(), tempMoved: false }
            },

            getCubeCoords(r, c) {
                const x = c - Math.floor(r / 2); const z = r; const y = -x - z;
                return { x, y, z };
            },

            getHexDist(r1, c1, r2, c2) {
                const a = this.getCubeCoords(r1, c1); const b = this.getCubeCoords(r2, c2);
                return Math.max(Math.abs(a.x - b.x), Math.abs(a.y - b.y), Math.abs(a.z - b.z));
            }
        };

        /**
         * VIEW: Ë°®Á§∫Âà∂Âæ°
         */
        const View = {
            canvas: null, ctx: null,

            changeScreen(screenId) {
                document.querySelectorAll('div[id^="screen-"]').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`screen-${screenId}`);
                if (target) target.classList.remove('hidden');
                Model.state.currentScreen = screenId;

                const status = document.getElementById('status-bar');
                const turn = document.getElementById('turn-indicator');
                const btn = document.getElementById('btn-end-strategic-turn');

                if (screenId === 'map') {
                    status.classList.remove('hidden'); turn.classList.remove('hidden'); btn.classList.remove('hidden');
                    this.initCanvas();
                } else {
                    status.classList.add('hidden'); turn.classList.add('hidden'); btn.classList.add('hidden');
                }
            },

            showMessage(text) {
                const box = document.getElementById('message-box');
                const txt = document.getElementById('message-text');
                txt.innerText = text;
                box.style.opacity = '1';
                if (window.msgTimer) clearTimeout(window.msgTimer);
                window.msgTimer = setTimeout(() => { box.style.opacity = '0'; }, 3500);
            },

            openModal(title, body, buttons) {
                const modal = document.getElementById('modal-layer');
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerText = body;
                const footer = document.getElementById('modal-footer');
                footer.innerHTML = '';
                buttons.forEach(btn => {
                    const b = document.createElement('button');
                    b.className = "px-10 py-4 bg-blue-700 hover:bg-blue-600 border-2 border-white text-2xl transition-colors font-bold rounded-lg shadow-lg text-white";
                    b.innerText = btn.label;
                    b.onclick = () => { modal.classList.add('hidden'); btn.action(); };
                    footer.appendChild(b);
                });
                modal.classList.remove('hidden');
            },

            showEnding(isWin) {
                const screen = document.getElementById('screen-ending');
                const title = document.getElementById('ending-title');
                const body = document.getElementById('ending-body');

                if (isWin) {
                    title.innerText = "VICTORY";
                    title.className = "text-8xl font-bold mb-12 text-yellow-500 uppercase tracking-tighter drop-shadow-[0_0_30px_rgba(234,179,8,0.5)]";
                    body.innerText = "ÊïµÂã¢Âäõ„ÅÆÊã†ÁÇπ„Çí„Åô„Åπ„Å¶Âà∂Âúß„Åó„ÄÅ„Éê„Éè„É†„Éº„ÉàÂ§ßÈô∏„Å´Áúü„ÅÆÂπ≥Âíå„ÅåË®™„Çå„Åü„ÄÇ„ÅÇ„Å™„Åü„ÅÆÂêç„ÅØ‰ºùË™¨„Å®„Å™„Çä„ÄÅÊ∞∏„ÅèË™û„ÇäÁ∂ô„Åå„Çå„Çã„Å†„Çç„ÅÜ„ÄÇ";
                } else {
                    title.innerText = "DEFEAT";
                    title.className = "text-8xl font-bold mb-12 text-red-600 uppercase tracking-tighter drop-shadow-[0_0_30px_rgba(220,38,38,0.5)]";
                    body.innerText = "ÂÖ®„Å¶„ÅÆÊã†ÁÇπ„ÇíÂ§±„ÅÑ„ÄÅÈáéÊúõ„ÅØÊΩ∞„Åà„Åü„ÄÇÂ§ßÈô∏„ÅÆÊ≠¥Âè≤„ÅØÂãùËÄÖ„Å´„Çà„Å£„Å¶Êõ∏„ÅçÊèõ„Åà„Çâ„Çå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂêç„ÅØÈóá„Å∏„Å®Ê∂à„Åà„Å¶„ÅÑ„Å£„Åü...";
                }

                this.changeScreen('ending');
            },

            initCanvas() {
                const canvas = document.getElementById('map-canvas');
                if (!canvas) return;
                const newCanvas = canvas.cloneNode(true);
                canvas.parentNode.replaceChild(newCanvas, canvas);
                newCanvas.width = window.innerWidth;
                newCanvas.height = window.innerHeight;
                this.ctx = newCanvas.getContext('2d');
                this.canvas = newCanvas;

                newCanvas.addEventListener('mousedown', Controller.handleMapClick);
                newCanvas.addEventListener('contextmenu', Controller.handleMapRightClick);
                requestAnimationFrame(() => this.renderMapLoop());
            },

            renderMapLoop() {
                if (Model.state.currentScreen !== 'map' || !this.ctx) return;
                const ctx = this.ctx;
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

                document.getElementById('castle-count-display').innerText = `${Model.state.castles.filter(c => c.owner === 'player').length} / ${Model.state.castles.length}`;
                document.getElementById('army-total-display').innerText = `${Model.state.mapUnits.filter(u => u.owner === 'player').length} / ${Model.MAX_ARMIES}`;
                document.getElementById('gold-amount').innerText = Math.floor(Model.state.gold);
                document.getElementById('enemy-gold-amount').innerText = Math.floor(Model.state.enemyGold);
                document.getElementById('turn-display').innerText = `TURN ${Model.state.turnCount}`;

                ctx.setLineDash([10, 5]); ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 4;
                Model.state.castles.forEach(c => {
                    c.neighbors.forEach(nId => {
                        const n = Model.state.castles.find(nc => nc.id === nId);
                        if (n) { ctx.beginPath(); ctx.moveTo(c.x, c.y); ctx.lineTo(n.x, n.y); ctx.stroke(); }
                    });
                });
                ctx.setLineDash([]);

                Model.state.castles.forEach(c => {
                    ctx.font = '50px serif'; ctx.textAlign = 'center'; ctx.fillText('üè∞', c.x, c.y);
                    ctx.font = '24px DotGothic16';
                    ctx.fillStyle = c.owner === 'player' ? '#44aaff' : (c.owner === 'enemy' ? '#ff4444' : '#aaaaaa');
                    ctx.fillText(c.name, c.x, c.y + 45);

                    // Êà¶ÂäõË°®Á§∫
                    const unitsAtCastle = Model.state.mapUnits.filter(u => Math.hypot(u.x - c.x, u.y - c.y) < 45);
                    const totalAtk = unitsAtCastle.reduce((sum, u) => sum + u.army.reduce((aSum, unit) => aSum + unit.atk, 0), 0);
                    const totalHp = unitsAtCastle.reduce((sum, u) => sum + u.army.reduce((aSum, unit) => aSum + unit.currentHp, 0), 0);
                    if (totalAtk > 0 || totalHp > 0) {
                        ctx.font = 'bold 16px DotGothic16';
                        ctx.fillStyle = '#ffffff';
                        ctx.shadowBlur = 4; ctx.shadowColor = 'black';
                        ctx.fillText(`‚öí${totalAtk} ‚ù§${totalHp}`, c.x, c.y - 45);
                        ctx.shadowBlur = 0;
                    }
                });

                Model.state.mapUnits.forEach(u => {
                    const isStationed = Model.state.castles.some(c => Math.hypot(u.x - c.x, u.y - c.y) < 30) && !u.isMoving;
                    if (isStationed && u !== Model.state.selectedMapUnit) return;

                    ctx.font = '40px serif';
                    if (u === Model.state.selectedMapUnit) { ctx.shadowBlur = 30; ctx.shadowColor = 'cyan'; }
                    ctx.globalAlpha = (u.owner === 'player' && u.hasActed) ? 0.4 : 1.0;
                    ctx.fillText(u.emoji, u.x, u.y);
                    ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;
                });

                requestAnimationFrame(() => this.renderMapLoop());
            },

            toggleBaseMenu(castle = null) {
                const el = document.getElementById('base-menu');
                if (el.classList.contains('hidden')) {
                    if (castle) this.renderBaseMenu(castle);
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            },

            renderBaseMenu(castle) {
                const sP = Model.state.mapUnits.filter(u => u.owner === 'player' && Math.hypot(u.x - castle.x, u.y - castle.y) < 45);
                const sE = Model.state.mapUnits.filter(u => u.owner === 'enemy' && Math.hypot(u.x - castle.x, u.y - castle.y) < 45);

                document.getElementById('base-menu-title').innerText = castle.name;
                document.getElementById('menu-gold-display').innerText = `${Math.floor(Model.state.gold)}G`;

                const ownerColor = castle.owner === 'player' ? 'text-blue-400' : 'text-red-400';
                const ownerText = castle.owner === 'player' ? 'Ëá™ËªçÈ†ò' : 'ÊïµÈ†ò„Éª‰∏≠Á´ã';
                const count = castle.owner === 'player' ? sP.length : sE.length;

                document.getElementById('castle-stat-panel').innerHTML = `
                    <div>ÊîØÈÖçÂã¢Âäõ: <span class="${ownerColor}">${ownerText}</span></div>
                    <div>ÈßêÁïôÈÉ®ÈöäÊï∞: <span class="text-white">${count}</span></div>
                `;

                const uniquePanel = document.getElementById('unique-unit-info-panel');
                if (castle.uniqueUnit) {
                    const u = Model.SPECIAL_UNITS[castle.uniqueUnit];
                    uniquePanel.classList.remove('hidden');
                    uniquePanel.innerHTML = `<div class="text-7xl">${u.emoji}</div><div><div class="text-yellow-500 font-bold text-3xl">Êã†ÁÇπÂõ∫ÊúâÂÖµ: ${u.name}</div><div class="text-xl text-gray-200 mt-2 uppercase font-bold text-white">HP:${u.hp} / ATK:${u.atk} / MOVE:${u.move} / RNG:${u.range} / COST:${u.cost}G</div></div>`;
                } else { uniquePanel.classList.add('hidden'); }

                const createBtn = document.getElementById('btn-create-army');
                createBtn.disabled = castle.owner !== 'player' || Model.state.gold < Model.ARMY_COST || Model.state.mapUnits.filter(u => u.owner === 'player').length >= Model.MAX_ARMIES;
                createBtn.onclick = () => Controller.createNewArmy(castle);

                const menuContent = document.getElementById('base-menu-content');
                const noMsg = document.getElementById('no-unit-message');
                menuContent.innerHTML = '';

                if (castle.owner === 'player' && sP.length > 0) {
                    noMsg.classList.add('hidden');
                    sP.forEach(unit => {
                        const card = document.createElement('div');
                        card.className = "bg-gray-800/80 border-2 border-gray-700 p-8 rounded-2xl shadow-2xl mb-4 text-white";
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-8 border-b border-gray-600 pb-4">
                                <div class="flex items-center gap-6"><span class="text-6xl">${unit.emoji}</span><span class="text-3xl font-bold text-blue-300">${unit.isMaster ? '‰∏ªËªç' : 'Âà•ÂÉçÈöä'}</span></div>
                                <span class="text-xl font-bold font-mono">ÊßãÊàê: ${unit.army.length} / ${Model.MAX_UNITS}</span>
                            </div>
                            <div class="grid grid-cols-1 gap-10">
                                <div class="bg-black/50 p-6 rounded-xl border border-blue-900/30">
                                    <p class="text-2xl text-blue-400 mb-6 font-bold border-b border-blue-900/50 pb-2 uppercase tracking-widest text-center">„É¶„Éã„ÉÉ„ÉàÈõáÁî®„ÉªÁ∑®Êàê</p>
                                    <div class="flex flex-col gap-6">
                                        <!-- Ë£úÂÖÖ„É¶„Éã„ÉÉ„ÉàÔºàÊñ∞Ë¶èÈõáÁî®Ôºâ„Çí‰∏äÈÉ®„Å´ÈÖçÁΩÆ -->
                                        <div>
                                            <p class="text-sm text-gray-400 mb-4 font-bold uppercase tracking-widest">Ë£úÂÖÖ„É¶„Éã„ÉÉ„ÉàÔºàÊñ∞Ë¶èÈõáÁî®Ôºâ</p>
                                            <div class="grid grid-cols-1 gap-4 mb-8">
                                                ${(() => {
                                const factionUnits = Model.FACTION_UNITS[Model.state.playerMaster.id];
                                let options = [...factionUnits];
                                if (castle.uniqueUnit) {
                                    const spec = Model.SPECIAL_UNITS[castle.uniqueUnit];
                                    if (spec) options.push(spec);
                                }
                                return options.map(ut => this.recruitItemHTML(ut, unit, castle)).join('');
                            })()}
                                            </div>
                                        </div>

                                        <!-- Êó¢Â≠ò„É¶„Éã„ÉÉ„ÉàÔºàÁ∑®ÊàêÊ∏à„ÅøÔºâ„Çí‰∏ãÈÉ®„Å´ÈÖçÁΩÆ -->
                                        <div class="pt-8 border-t border-gray-700">
                                            <p class="text-sm text-gray-400 mb-4 font-bold uppercase tracking-widest">Á∑®ÊàêÊ∏à„Åø„É¶„Éã„ÉÉ„ÉàÔºàË©≥Á¥∞„ÉªÂº∑ÂåñÔºâ</p>
                                            <div class="flex flex-col gap-6">
                                                ${unit.army.map((u, i) => `
                                                    <div class="bg-gray-900 p-4 border border-gray-700 rounded-lg">
                                                        <div class="flex justify-between items-center mb-4">
                                                            <div class="flex items-center gap-4">
                                                                <span class="text-5xl">${u.emoji}</span>
                                                                <div>
                                                                    <div class="text-2xl font-bold">${u.name} <span class="text-yellow-500 ml-2 text-xl">RANK ${Model.RANKS[u.rank || 0]}</span></div>
                                                                    <div class="text-sm text-gray-400">Á∑¥Â∫¶: ${u.rank === 5 ? 'MAX' : (u.xp || 0) + ' / ' + Model.RANK_UP_XP}</div>
                                                                </div>
                                                            </div>
                                                            <div class="text-right">
                                                                <div class="text-green-400 font-bold">HP: ${u.currentHp}/${u.hp}</div>
                                                                <div class="text-red-400 font-bold">ATK: ${u.atk}</div>
                                                            </div>
                                                        </div>
                                                        <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden mb-4">
                                                            <div class="h-full bg-yellow-500" style="width:${u.rank === 5 ? 100 : ((u.xp || 0) / Model.RANK_UP_XP) * 100}%"></div>
                                                        </div>
                                                        <div class="flex gap-4">
                                                            <button onclick="Controller.enhanceUnit('${unit.id}', ${i}, 'hp', '${castle.id}')" class="flex-1 py-2 bg-green-900/50 border border-green-700 hover:bg-green-700 text-sm font-bold uppercase transition-colors text-white">HP+10(100G)</button>
                                                            <button onclick="Controller.enhanceUnit('${unit.id}', ${i}, 'atk', '${castle.id}')" class="flex-1 py-2 bg-red-900/50 border border-red-700 hover:bg-red-700 text-sm font-bold uppercase transition-colors text-white">ATK+3(150G)</button>
                                                        </div>
                                                    </div>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        menuContent.appendChild(card);
                    });
                } else {
                    noMsg.classList.remove('hidden');
                    if (castle.owner !== 'player') noMsg.innerText = sE.length > 0 ? "ÊïµÈÉ®Èöä„ÅåÂÆàÂÇô„Åó„Å¶„ÅÑ„Åæ„Åô" : "Èò≤Ë°õÈÉ®Èöä„ÅØ„ÅÑ„Åæ„Åõ„Çì";
                }
            },

            recruitItemHTML(ut, unit, castle) {
                const can = Model.state.gold >= ut.cost;
                const isFull = unit.army.length >= Model.MAX_UNITS;
                const dis = isFull || !can || castle.owner !== 'player';
                const lbl = isFull ? "Ê∫ÄÂì°" : `${ut.cost}G`;
                return `<div class="recruit-item flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/10 cursor-pointer transition-colors" 
                    onclick="View.showMessage('„Äê${ut.name}„Äë HP:${ut.hp} / ATK:${ut.atk} / RNG:${ut.range} / MOVE:${ut.move}')">
                    <div class="flex items-center gap-6">
                        <span class="text-6xl">${ut.emoji}</span>
                        <div>
                            <div class="text-3xl font-bold text-white">${ut.name}</div>
                            <div class="text-sm text-blue-400 font-bold uppercase font-mono">„Çπ„Éö„ÉÉ„ÇØ„ÇíË°®Á§∫ (Click)</div>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); Controller.recruitUnit('${unit.id}', '${ut.id}', '${castle.id}')" 
                        class="px-10 py-4 bg-blue-900 border-2 border-blue-400 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-2xl font-bold shadow-2xl active:translate-y-1 text-white" 
                        ${dis ? 'disabled' : ''}>${lbl}</button>
                </div>`;
            },

            updateBattleUI() {
                const b = Model.state.battle;
                b.grid.forEach(cell => { cell.el.innerHTML = ''; cell.el.classList.remove('bg-blue-900/40', 'bg-red-900/40', 'ring-4', 'ring-white'); });
                b.units.forEach(u => {
                    const cell = b.grid.find(g => g.r === u.r && g.c === u.c);
                    if (cell) {
                        const div = document.createElement('div'); div.className = "relative flex flex-col items-center justify-center pointer-events-none w-full h-full";
                        div.innerHTML = `
                            <div class="flex items-center gap-1 mb-1">
                                <span class="text-4xl shadow-black drop-shadow-md">${u.emoji}</span>
                                <span class="text-[10px] text-yellow-500 font-bold bg-black/50 px-1 rounded">${Model.RANKS[u.rank || 0]}</span>
                            </div>
                            <div class="w-12 h-1.5 bg-gray-900 border border-gray-600 rounded-full overflow-hidden shadow-sm">
                                <div class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-300" style="width:${Math.max(0, (u.currentHp / u.hp) * 100)}%"></div>
                            </div>`;
                        if (b.movedUnits.has(u)) div.style.opacity = "0.4";
                        cell.el.appendChild(div);
                    }
                });
                if (b.selectedUnit) {
                    const s = b.selectedUnit;
                    const sc = b.grid.find(g => g.r === s.r && g.c === s.c);
                    if (sc) sc.el.classList.add('ring-4', 'ring-white');
                    b.grid.forEach(cell => {
                        const d = Model.getHexDist(s.r, s.c, cell.r, cell.c);
                        if (!b.tempMoved && d > 0 && d <= s.move && !b.units.some(u => u.r === cell.r && u.c === cell.c)) cell.el.classList.add('bg-blue-900/40');
                        if (!(s.range > 1 && b.tempMoved) && d > 0 && d <= s.range) cell.el.classList.add('bg-red-900/40');
                    });
                }
                const btn = document.getElementById('battle-end-turn-btn');
                if (btn) btn.disabled = (b.turn !== 'player');
            }
        };

        /**
         * CONTROLLER: Âà∂Âæ°„É≠„Ç∏„ÉÉ„ÇØ
         */
        const Controller = {
            init() { setInterval(() => this.updateLogic(), 50); },

            showMasterSelection() {
                View.changeScreen('select');
                const container = document.querySelector('#screen-select div');
                container.innerHTML = Model.MASTERS.map(m => `
                    <div class="bg-gray-800 border-2 border-gray-600 p-10 hover:border-white cursor-pointer flex flex-col items-center transition-transform hover:scale-105 shadow-2xl text-white text-white" 
                         onclick="Controller.selectMaster('${m.id}')">
                        <div class="text-9xl mb-8 text-white">${m.emoji}</div>
                        <div class="text-4xl font-bold mb-4" style="color:${m.color}">${m.name}</div>
                        <p class="text-xl text-center text-gray-400 font-bold text-white">${m.desc}</p>
                    </div>`).join('');
            },

            selectMaster(id) {
                Model.state.playerMaster = Model.MASTERS.find(m => m.id === id);
                document.getElementById('master-name').innerText = Model.state.playerMaster.name;
                document.getElementById('master-name').style.color = Model.state.playerMaster.color;
                document.getElementById('master-alignment').innerText = Model.state.playerMaster.alignment;

                Model.state.castles = [
                    { id: 'c1', name: 'ÁéãÈÉΩ', x: 150, y: 200, owner: 'player', captureBonus: 0, uniqueUnit: null, neighbors: ['c3', 'c7'] },
                    { id: 'c2', name: 'ÊöóÈªíÂüé', x: 750, y: 550, owner: 'enemy', captureBonus: 2000, uniqueUnit: 'hell-hound', neighbors: ['c3', 'c5', 'c6'] },
                    { id: 'c3', name: 'Ëá™Áî±ÈÉΩÂ∏Ç', x: 450, y: 350, owner: 'neutral', captureBonus: 500, uniqueUnit: 'guard', neighbors: ['c1', 'c2', 'c4', 'c5'] },
                    { id: 'c4', name: 'Âåó„ÅÆÁ†¶', x: 450, y: 100, owner: 'neutral', captureBonus: 350, uniqueUnit: 'crossbow', neighbors: ['c3', 'c6'] },
                    { id: 'c5', name: 'Âçó„ÅÆÊùë', x: 250, y: 550, owner: 'neutral', captureBonus: 200, uniqueUnit: 'militia', neighbors: ['c2', 'c3'] },
                    { id: 'c6', name: 'Êù±„ÅÆÂ°î', x: 750, y: 150, owner: 'neutral', captureBonus: 800, uniqueUnit: 'sorcerer', neighbors: ['c2', 'c4'] },
                    { id: 'c7', name: 'Ë•ø„ÅÆÂªÉÂ¢ü', x: 100, y: 450, owner: 'neutral', captureBonus: 400, uniqueUnit: 'ghost', neighbors: ['c1'] }
                ];

                Model.state.mapUnits = [
                    { id: 'master-army', owner: 'player', x: 150, y: 200, targetX: 150, targetY: 200, emoji: Model.state.playerMaster.emoji, army: Model.FACTION_UNITS[id].map(u => ({ ...u, currentHp: u.hp, rank: 0, xp: 0 })), isMaster: true, hasActed: false, isMoving: false },
                    { id: 'enemy-1', owner: 'enemy', x: 750, y: 550, targetX: 750, targetY: 550, emoji: 'üëπ', army: Model.FACTION_UNITS['demon'].map(u => ({ ...u, currentHp: u.hp, rank: 0, xp: 0 })), isMaster: false, hasActed: false, isMoving: false }
                ];
                View.changeScreen('map');
            },

            updateLogic() {
                if (Model.state.currentScreen !== 'map') return;

                Model.state.mapUnits.forEach(u => {
                    const dx = u.targetX - u.x, dy = u.targetY - u.y, dist = Math.hypot(dx, dy);
                    if (dist > Model.UNIT_SPEED) { u.x += dx / dist * Model.UNIT_SPEED; u.y += dy / dist * Model.UNIT_SPEED; }
                    else { u.x = u.targetX; u.y = u.targetY; u.isMoving = false; }
                });

                if (Model.state.encounterCooldown > 0) Model.state.encounterCooldown--;
                if (Model.state.encounterCooldown <= 0 && !Model.state.gameCleared) {
                    for (let i = 0; i < Model.state.mapUnits.length; i++) {
                        for (let j = i + 1; j < Model.state.mapUnits.length; j++) {
                            const u1 = Model.state.mapUnits[i], u2 = Model.state.mapUnits[j];
                            if (u1.owner !== u2.owner && Math.hypot(u1.x - u2.x, u1.y - u2.y) < 30) {
                                u1.isMoving = false; u2.isMoving = false;
                                // hasActed„ÅØÊà¶ÈóòÁµÇ‰∫ÜÂæå„Å´Ë®≠ÂÆö„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØË®≠ÂÆö„Åó„Å™„ÅÑ
                                Model.state.encounterEnemy = (u1.owner === 'enemy') ? u1 : u2;
                                Model.state.encounterPlayer = (u1.owner === 'player') ? u1 : u2;
                                this.startBattle(); return;
                            }
                        }
                    }
                }

                Model.state.castles.forEach(c => {
                    const unitsOnCastle = Model.state.mapUnits.filter(u => Math.hypot(u.x - c.x, u.y - c.y) < 40);
                    const currentGuard = unitsOnCastle.find(u => u.owner === c.owner);

                    if (!currentGuard) {
                        const player = unitsOnCastle.find(u => u.owner === 'player' && !u.isMoving);
                        const enemy = unitsOnCastle.find(u => u.owner === 'enemy' && !u.isMoving);
                        if (player && !enemy && c.owner !== 'player') {
                            Model.state.gold += c.captureBonus;
                            c.captureBonus = 0; // „Éú„Éº„Éä„ÇπÂèñÂæóÊ∏à„Åø
                            c.owner = 'player'; View.showMessage(`${c.name}Âà∂ÂúßÔºÅ`);

                            // ÊïµÊú¨Êã†Âú∞ÔºàÊöóÈªíÂüéÔºâÈô•ËêΩ„Å´„Çà„ÇãÈôç‰ºè
                            if (c.id === 'c2') {
                                View.showMessage("Êïµ„ÅÆÊöóÈªíÂüé„ÅåÈô•ËêΩÔºÅ ÊïµËªç„ÅØÈôç‰ºè„Åó„Åæ„Åó„Åü„ÄÇ");
                                Model.state.mapUnits = Model.state.mapUnits.filter(u => u.owner !== 'enemy');
                                Model.state.castles.forEach(cas => { if (cas.owner === 'enemy') cas.owner = 'player'; });
                            }

                            this.checkWinCondition();
                        } else if (enemy && !player && c.owner !== 'enemy') {
                            Model.state.enemyGold += c.captureBonus;
                            c.captureBonus = 0;
                            c.owner = 'enemy';

                            // Ëá™ËªçÊú¨Êã†Âú∞ÔºàÁéãÈÉΩÔºâÈô•ËêΩ„Å´„Çà„ÇãÊïóÂåó
                            if (c.id === 'c1') {
                                Model.state.gameCleared = true;
                                View.showEnding(false);
                                return;
                            }

                            this.checkWinCondition(); // ÊïóÂåóÂà§ÂÆö„ÅÆ„Åü„ÇÅ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                        }
                    }
                });

                // Êïµ„Çø„Éº„É≥‰∏≠„Å´ÂÖ®ÈÉ®Èöä„ÅÆÁßªÂãï„ÅåÂÆå‰∫Ü„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Éó„É¨„Ç§„É§„Éº„Çø„Éº„É≥„Å∏
                if (Model.state.strategicTurn === 'enemy' && Model.state.enemyTurnStarted) {
                    const anyMoving = Model.state.mapUnits.some(u => u.isMoving);
                    const battleActive = Model.state.currentScreen === 'battle';
                    const encounterWaiting = Model.state.encounterCooldown > 0;
                    if (!anyMoving && !battleActive && !encounterWaiting) {
                        this.startPlayerTurn();
                    }
                }
            },

            checkWinCondition() {
                if (Model.state.gameCleared) return;
                const pOwned = Model.state.castles.filter(c => c.owner === 'player').length;
                const eOwned = Model.state.castles.filter(c => c.owner === 'enemy').length;

                if (eOwned === 0) {
                    Model.state.gameCleared = true;
                    setTimeout(() => View.showEnding(true), 1500); // Èôç‰ºèÊºîÂá∫„ÇíË¶ã„Åõ„Çã„Åü„ÇÅÂ∞ë„ÅóÂæÖ„Å§
                } else if (pOwned === 0) {
                    Model.state.gameCleared = true;
                    View.showEnding(false);
                }
            },

            handleMapClick(e) {
                if (e.button !== 0 || Model.state.strategicTurn !== 'player' || Model.state.gameCleared) return;
                const rect = View.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;

                // 1. „Åô„Åß„Å´ÈÉ®Èöä„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åæ„ÅöÁßªÂãïÂÖàÔºàÊã†ÁÇπÔºâ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Åã„ÇíÁ¢∫Ë™ç
                if (Model.state.selectedMapUnit) {
                    const castle = Model.state.castles.find(c => Math.hypot(c.x - x, c.y - y) < 45);
                    if (castle) {
                        const current = Model.state.castles.find(c => Math.hypot(c.x - Model.state.selectedMapUnit.x, c.y - Model.state.selectedMapUnit.y) < 45);
                        if (current && current.neighbors.includes(castle.id)) {
                            Model.state.selectedMapUnit.targetX = castle.x; Model.state.selectedMapUnit.targetY = castle.y;
                            Model.state.selectedMapUnit.isMoving = true; Model.state.selectedMapUnit.hasActed = true;
                            Model.state.selectedMapUnit = null;
                            return; // ÁßªÂãï„ÇíÂÆüË°å„Åó„Åü„ÅÆ„ÅßÁµÇ‰∫Ü
                        } else {
                            View.showMessage("Èö£Êé•„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                            // Èö£Êé•„Åó„Å¶„ÅÑ„Å™„ÅÑÊã†ÁÇπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§„Åõ„Åö„ÄÅÈÉ®ÈöäÂàá„ÇäÊõø„ÅàÂà§ÂÆö„Å∏ÊµÅ„Åô„Åì„Å®„ÇÇÂèØËÉΩ„Å†„Åå„ÄÅ
                            // „Åì„Åì„Åß„ÅØ‰∏ÄÊó¶„ÇØ„É™„ÉÉ„ÇØ„ÇíÊ∂àË≤ª
                        }
                    }
                }

                // 2. Êã†ÁÇπ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØÁßªÂãï‰∏çÂèØ„Å†„Å£„ÅüÂ†¥Âêà„ÄÅÈÉ®Èöä„ÅÆÈÅ∏Êäû„ÉªÂàá„ÇäÊõø„Åà„ÇíË°å„ÅÜ
                const clickedUnits = Model.state.mapUnits.filter(u => u.owner === 'player' && !u.hasActed && Math.hypot(u.x - x, u.y - y) < 45);
                if (clickedUnits.length > 0) {
                    let nextIdx = 0;
                    if (Model.state.selectedMapUnit && clickedUnits.includes(Model.state.selectedMapUnit)) {
                        nextIdx = (clickedUnits.indexOf(Model.state.selectedMapUnit) + 1) % clickedUnits.length;
                    }
                    Model.state.selectedMapUnit = clickedUnits[nextIdx];
                } else {
                    // ‰Ωï„ÇÇ„Å™„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈÅ∏ÊäûËß£Èô§
                    Model.state.selectedMapUnit = null;
                }
            },

            handleMapRightClick(e) {
                e.preventDefault();
                if (Model.state.strategicTurn !== 'player') return;
                const rect = View.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                const clickedCastle = Model.state.castles.find(c => Math.hypot(c.x - x, c.y - y) < 45);
                if (clickedCastle) View.toggleBaseMenu(clickedCastle);
            },

            endStrategicTurn() {
                if (Model.state.strategicTurn !== 'player') return;

                const movingUnit = Model.state.mapUnits.find(u => u.owner === 'player' && u.isMoving);
                if (movingUnit) { View.showMessage("ÈÉ®Èöä„ÅåÁßªÂãï‰∏≠„Åß„Åô„ÄÇÂÆå‰∫Ü„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }

                Model.state.strategicTurn = 'enemy';
                Model.state.enemyTurnStarted = false;
                document.getElementById('turn-text').innerText = "Enemy Turn";
                document.getElementById('turn-text').classList.add('text-red-500');
                document.getElementById('btn-end-strategic-turn').classList.add('hidden');
                document.getElementById('save-load-group').classList.add('hidden');

                setTimeout(() => {
                    Model.state.enemyTurnStarted = true;
                    const enemyCastles = Model.state.castles.filter(c => c.owner === 'enemy');
                    const enemyCastleCount = enemyCastles.length;
                    Model.state.enemyGold += (100 + enemyCastleCount * 200);

                    // 1. ÈÉ®Èöä„ÅÆÊñ∞Ë¶èÁ∑®ÊàêÔºàË≥áÈáë„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
                    // Êïµ„ÅÆÊú¨Êã†Âú∞„ÄÅ„Åæ„Åü„ÅØÊîØÈÖç‰∏ã„ÅÆ„Åô„Åπ„Å¶„ÅÆÊã†ÁÇπ„ÅßÁîüÁî£„ÇíË©¶„Åø„Çã
                    enemyCastles.forEach(castle => {
                        const enemyUnitsAtCastle = Model.state.mapUnits.filter(u => u.owner === 'enemy' && Math.hypot(u.x - castle.x, u.y - castle.y) < 45);
                        const totalEnemyArmies = Model.state.mapUnits.filter(u => u.owner === 'enemy').length;

                        // Êã†ÁÇπ„Å´ÈÉ®Èöä„Åå„ÅÑ„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØÊú¨Êã†Âú∞(c2)„ÅßÂÆàÂÇôÈöä„Åå1„Å§„Åó„Åã„ÅÑ„Å™„ÅÑÂ†¥Âêà„Å´Êñ∞„Åó„ÅÑÈÉ®Èöä„Çí‰ΩúÊàê
                        const needsNewArmy = (enemyUnitsAtCastle.length === 0) || (castle.id === 'c2' && enemyUnitsAtCastle.length < 2);

                        if (needsNewArmy && totalEnemyArmies < Model.MAX_ARMIES && Model.state.enemyGold >= Model.ARMY_COST) {
                            Model.state.enemyGold -= Model.ARMY_COST;
                            Model.state.mapUnits.push({
                                id: 'enemy-army-' + Date.now() + Math.random(),
                                owner: 'enemy', x: castle.x, y: castle.y, targetX: castle.x, targetY: castle.y,
                                emoji: 'üö©',
                                army: [{ ...Model.FACTION_UNITS['demon'][0], currentHp: Model.FACTION_UNITS['demon'][0].hp, rank: 0, xp: 0 }],
                                isMaster: false, hasActed: true, isMoving: false
                            });
                        }
                    });

                    // 2. Êó¢Â≠òÈÉ®Èöä„Å∏„ÅÆ„É¶„Éã„ÉÉ„ÉàËøΩÂä†ÔºàÊà¶Âäõ„Åå‰∏äÈôê„Å´ÈÅî„Åô„Çã„Åæ„ÅßÈõáÁî®Ôºâ
                    Model.state.mapUnits.filter(u => u.owner === 'enemy').forEach(enemyArmy => {
                        const castle = Model.state.castles.find(c => c.owner === 'enemy' && Math.hypot(c.x - enemyArmy.x, c.y - enemyArmy.y) < 45);
                        if (castle) {
                            // „Åù„ÅÆÊã†ÁÇπ„ÅÆÂõ∫Êúâ„É¶„Éã„ÉÉ„Éà„ÇÇÂÄôË£ú„Å´Âä†„Åà„Çã
                            let recruitOptions = [...Model.FACTION_UNITS['demon']];
                            if (castle.uniqueUnit) recruitOptions.push(Model.SPECIAL_UNITS[castle.uniqueUnit]);

                            while (enemyArmy.army.length < Model.MAX_UNITS) {
                                // Ë≥áÈáë„ÅåË®±„ÅôÈôê„Çä„ÄÅÈ´ò‰æ°„Å™„É¶„Éã„ÉÉ„ÉàÔºàÂº∑„ÅÑ„É¶„Éã„ÉÉ„ÉàÔºâ„Åã„ÇâÂÑ™ÂÖàÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                                const affordableUnits = recruitOptions.filter(ut => Model.state.enemyGold >= ut.cost);
                                if (affordableUnits.length === 0) break;

                                // ÊúÄ„ÇÇÈ´ò„ÅÑ„É¶„Éã„ÉÉ„Éà„ÄÅ„Åæ„Åü„ÅØ„É©„É≥„ÉÄ„É†„ÅßÈÅ∏ÊäûÔºàÂ∞ë„Åó„ÅÆÊè∫„Çâ„Åé„ÇíÊåÅ„Åü„Åõ„ÇãÔºâ
                                affordableUnits.sort((a, b) => b.cost - a.cost);
                                const unitToRecruit = Math.random() > 0.3 ? affordableUnits[0] : affordableUnits[Math.floor(Math.random() * affordableUnits.length)];

                                Model.state.enemyGold -= unitToRecruit.cost;
                                enemyArmy.army.push({ ...unitToRecruit, currentHp: unitToRecruit.hp, rank: 0, xp: 0 });
                            }
                        }
                    });

                    // 3. ÁßªÂãï„É≠„Ç∏„ÉÉ„ÇØÔºöÊú¨Êã†Âú∞Èò≤Ë°õÊúÄÂÑ™ÂÖà
                    Model.state.mapUnits.filter(u => u.owner === 'enemy').forEach(enemy => {
                        const current = Model.state.castles.find(c => Math.hypot(c.x - enemy.x, c.y - enemy.y) < 45);
                        if (!current) return;

                        // Êà¶Áï•ÁöÑÂà§Êñ≠
                        const isCapital = (current.id === 'c2');
                        const enemyUnitsAtCapital = Model.state.mapUnits.filter(u => u.owner === 'enemy' && Math.hypot(u.x - Model.state.castles.find(c => c.id === 'c2').x, u.y - Model.state.castles.find(c => c.id === 'c2').y) < 45);

                        // A. Êú¨Êã†Âú∞„Å´„ÅÑ„ÇãÂ†¥ÂêàÔºöÂÆà„Çä„Å§„Å§„ÄÅ‰ΩôÂâ∞Êà¶Âäõ„ÅØÂá∫ÊíÉ
                        if (isCapital) {
                            // Êú¨Êã†Âú∞„Å´2ÈÉ®Èöä‰ª•‰∏ä„ÅÑ„Çã„Å™„Çâ„ÄÅ„Åù„ÅÆÈÉ®Èöä„ÅØ 60% „ÅÆÁ¢∫Áéá„ÅßÂá∫ÊíÉ„ÇíË©¶„Åø„Çã
                            if (enemyUnitsAtCapital.length < 2 || Math.random() < 0.4) return;
                        }

                        // B. Êú¨Êã†Âú∞„ÅåÁ©∫„ÅÆÂ†¥ÂêàÔºöËøë„Åè„ÅÆÈÉ®Èöä„ÅåÊàª„Çã
                        if (enemyUnitsAtCapital.length === 0) {
                            const capital = Model.state.castles.find(c => c.id === 'c2');
                            if (current.neighbors.includes(capital.id)) {
                                enemy.targetX = capital.x; enemy.targetY = capital.y; enemy.isMoving = true;
                                return;
                            }
                        }

                        // C. ÈÄöÂ∏∏„ÅÆÁßªÂãïÔºàÈö£Êé•Êã†ÁÇπ„Å∏Ôºâ
                        if (current.neighbors.length > 0) {
                            // 50%„ÅÆÁ¢∫Áéá„ÅßÁßªÂãïÔºà„Çà„Çä„Ç¢„Ç∞„É¨„ÉÉ„Ç∑„Éñ„Å´Ôºâ
                            if (Math.random() > 0.5) {
                                // „Éó„É¨„Ç§„É§„Éº„ÅÆÊã†ÁÇπ„ÄÅ„Åæ„Åü„ÅØ‰∏≠Á´ãÊã†ÁÇπ„ÇíÂÑ™ÂÖàÁöÑ„Å´Áãô„ÅÜ
                                const targets = current.neighbors
                                    .map(id => Model.state.castles.find(c => c.id === id))
                                    .sort((a, b) => {
                                        if (a.owner === 'player') return -1;
                                        if (a.owner === 'neutral' && b.owner === 'enemy') return -1;
                                        return 1;
                                    });

                                const next = targets[0]; // ÊúÄÂÑ™ÂÖà„Çø„Éº„Ç≤„ÉÉ„Éà
                                // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅåËá™ËªçÈ†ò„Åã„Å§Êó¢„Å´Ë™∞„ÅãÂÆà„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰ΩéÁ¢∫Áéá„Åß„Åó„ÅãË°å„Åã„Å™„ÅÑ
                                const guards = Model.state.mapUnits.filter(u => u.owner === 'enemy' && Math.hypot(u.x - next.x, u.y - next.y) < 45);
                                if (next.owner === 'enemy' && guards.length > 0 && Math.random() > 0.2) return;

                                enemy.targetX = next.x; enemy.targetY = next.y; enemy.isMoving = true;
                            }
                        }
                    });
                    // Ê¨°„ÅÆ„Çø„Éº„É≥„ÅÆÈñãÂßãÔºàstartPlayerTurnÔºâ„ÅØ updateLogic ÂÜÖ„ÅÆÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„ÅßË°å„ÅÜ
                }, 1000);
            },

            startPlayerTurn() {
                Model.state.turnCount++;
                Model.state.strategicTurn = 'player';
                document.getElementById('turn-text').innerText = "Player Turn";
                document.getElementById('turn-text').classList.remove('text-red-500');
                document.getElementById('btn-end-strategic-turn').classList.remove('hidden');
                document.getElementById('save-load-group').classList.remove('hidden');
                const income = 100 + Model.state.castles.filter(c => c.owner === 'player').length * 200;
                Model.state.gold += income;
                Model.state.mapUnits.forEach(u => u.hasActed = false);
                View.showMessage(`„Çø„Éº„É≥ÈñãÂßãÔºöÂèéÂÖ• ${income}G`);
            },

            createNewArmy(castle) {
                if (Model.state.gold < Model.ARMY_COST) return;
                if (Model.state.mapUnits.filter(u => u.owner === 'player').length >= Model.MAX_ARMIES) {
                    View.showMessage("ÈÉ®ÈöäÊï∞„Åå‰∏äÈôê„Å´ÈÅî„Åó„Å¶„ÅÑ„Åæ„Åô");
                    return;
                }
                Model.state.gold -= Model.ARMY_COST;
                Model.state.mapUnits.push({ id: 'army-' + Date.now(), owner: 'player', x: castle.x, y: castle.y, targetX: castle.x, targetY: castle.y, emoji: 'üö©', army: [{ ...Model.FACTION_UNITS[Model.state.playerMaster.id][0], currentHp: Model.FACTION_UNITS[Model.state.playerMaster.id][0].hp, rank: 0, xp: 0 }], isMaster: false, hasActed: true, isMoving: false });
                View.renderBaseMenu(castle);
            },

            recruitUnit(aId, utId, cId) {
                const army = Model.state.mapUnits.find(u => u.id === aId);
                const ut = Model.FACTION_UNITS[Model.state.playerMaster.id].find(x => x.id === utId) || Model.SPECIAL_UNITS[utId];
                if (army && ut && army.army.length < Model.MAX_UNITS && Model.state.gold >= ut.cost) {
                    Model.state.gold -= ut.cost; army.army.push({ ...ut, currentHp: ut.hp, rank: 0, xp: 0 });
                    View.renderBaseMenu(Model.state.castles.find(c => c.id === cId));
                }
            },

            enhanceUnit(aId, idx, type, cId) {
                const army = Model.state.mapUnits.find(u => u.id === aId);
                if (!army) return;
                const unit = army.army[idx];
                if (type === 'hp' && Model.state.gold >= 100) { Model.state.gold -= 100; unit.hp += 10; unit.currentHp += 10; }
                else if (type === 'atk' && Model.state.gold >= 150) { Model.state.gold -= 150; unit.atk += 3; }
                View.renderBaseMenu(Model.state.castles.find(c => c.id === cId));
            },

            startBattle() {
                window.gameState = Model.state;
                View.changeScreen('battle');
                this.initBattleGrid();
            },

            initBattleGrid() {
                const grid = document.getElementById('battle-grid'); grid.innerHTML = '';
                const cols = 7, rows = 6, hexSize = 90;
                Model.state.battle.grid = [];
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        // Ê®ôÊ∫ñÁöÑ„Å™„Éù„Ç§„É≥„Éà„Éà„ÉÉ„Éó„Éª„Éò„ÉÉ„ÇØ„Çπ„ÅÆÈÖçÁΩÆË®àÁÆó
                        const x = c * hexSize + (r % 2 ? hexSize / 2 : 0);
                        const y = r * hexSize * 0.75;
                        const hex = document.createElement('div');
                        hex.className = 'hex hex-active absolute bg-slate-800/60 border border-slate-700 flex items-center justify-center transition-all duration-200 shadow-inner';
                        hex.style.width = `${hexSize}px`; hex.style.height = `${hexSize}px`; hex.style.left = `${x}px`; hex.style.top = `${y}px`;
                        hex.onclick = () => this.handleBattleHexClick(r, c);
                        hex.oncontextmenu = (e) => { e.preventDefault(); this.handleBattleUnitRightClick(r, c); };
                        grid.appendChild(hex); Model.state.battle.grid.push({ r, c, el: hex });
                    }
                }
                grid.style.width = `${(cols + 0.5) * hexSize}px`; grid.style.height = `${(rows * 0.75 + 0.25) * hexSize}px`;
                const pU = Model.state.encounterPlayer.army.map((u, i) => ({ ...u, r: 1 + i, c: 0, owner: 'player' })), eU = Model.state.encounterEnemy.army.map((u, i) => ({ ...u, r: 1 + i, c: 6, owner: 'enemy' }));
                Model.state.battle.units = [...pU, ...eU]; Model.state.battle.movedUnits = new Set(); Model.state.battle.selectedUnit = null; Model.state.battle.tempMoved = false; Model.state.battle.turn = 'player'; Model.state.battle.active = true;
                View.updateBattleUI();
            },

            handleBattleHexClick(r, c) {
                const b = Model.state.battle; if (b.turn !== 'player' || !b.active) return;
                const target = b.units.find(u => u.r === r && u.c === c);
                if (b.selectedUnit && b.tempMoved) {
                    const s = b.selectedUnit; const d = Model.getHexDist(s.r, s.c, r, c);
                    if (target && target.owner === 'enemy' && d <= s.range) {
                        if (s.range > 1) View.showMessage("ÈÅ†Ë∑ùÈõ¢„ÅØÁßªÂãïÂâç„ÅÆ„Åø"); else this.battleAttack(s, target);
                    } else { b.movedUnits.add(s); b.selectedUnit = null; b.tempMoved = false; if (target && target.owner === 'player' && !b.movedUnits.has(target)) b.selectedUnit = target; }
                    View.updateBattleUI(); return;
                }
                if (target && target.owner === 'player') { if (!b.movedUnits.has(target)) { b.selectedUnit = target; b.tempMoved = false; } View.updateBattleUI(); return; }
                if (b.selectedUnit) {
                    const s = b.selectedUnit, d = Model.getHexDist(s.r, s.c, r, c);
                    if (target && target.owner === 'enemy') { if (d <= s.range) this.battleAttack(s, target); }
                    else if (!target && d <= s.move) { s.r = r; s.c = c; b.tempMoved = true; }
                    else { b.selectedUnit = null; }
                }
                View.updateBattleUI(); this.checkBattleEnd();
            },

            handleBattleUnitRightClick(r, c) {
                const b = Model.state.battle; if (!b.active) return;
                const u = b.units.find(u => u.r === r && u.c === c);
                if (u) {
                    const rank = Model.RANKS[u.rank || 0];
                    const xpText = u.rank === 5 ? "MAX" : `${u.xp || 0} / ${Model.RANK_UP_XP}`;
                    const statusText = `„Äê${u.name}„Äë (${u.owner === 'player' ? 'Ëá™Ëªç' : 'ÊïµËªç'})
 RANK: ${rank} (XP: ${xpText})
 HP: ${u.currentHp} / ${u.hp}  ATK: ${u.atk}
 RANGE: ${u.range}  MOVE: ${u.move}`;
                    View.showMessage(statusText);
                }
            },

            battleAttack(atk, def) {
                const dmg = Math.floor(atk.atk * (0.8 + Math.random() * 0.4)); def.currentHp -= dmg;
                View.showMessage(`${atk.name}„ÅÆÊîªÊíÉÔºÅ ${def.name}„Å´${dmg}„ÉÄ„É°ÔºÅ`);

                // XPÁç≤Âæó
                this.gainXp(atk, 10);

                Model.state.battle.movedUnits.add(atk); Model.state.battle.selectedUnit = null; Model.state.battle.tempMoved = false;
                if (def.currentHp <= 0) {
                    this.gainXp(atk, 30); // ÊíÉÁ†¥„Éú„Éº„Éä„Çπ
                    Model.state.battle.units = Model.state.battle.units.filter(u => u !== def);
                }
            },

            gainXp(unit, amount) {
                if (unit.rank === 5) return; // S„É©„É≥„ÇØ„ÅØÊàêÈï∑ÂÅúÊ≠¢
                if (!unit.xp && unit.xp !== 0) { unit.xp = 0; unit.rank = 0; }
                unit.xp += amount;
                if (unit.xp >= Model.RANK_UP_XP) {
                    unit.xp -= Model.RANK_UP_XP;
                    unit.rank++;

                    // ÂêÑËÉΩÂäõ„ÅÆ„Åù„ÅÆÊôÇÁÇπ„ÅÆÂÄ§„ÅÆ20%Âêë‰∏ä
                    const hpBonus = Math.max(1, Math.floor(unit.hp * 0.2));
                    const atkBonus = Math.max(1, Math.floor(unit.atk * 0.2));

                    unit.hp += hpBonus;
                    unit.currentHp += hpBonus;
                    unit.atk += atkBonus;

                    View.showMessage(`${unit.name}„Åå„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÔºÅ RANK ${Model.RANKS[unit.rank]}„Å´„Å™„Å£„ÅüÔºÅ\n(HP+${hpBonus}, ATK+${atkBonus})`);
                    if (unit.rank === 5) { unit.xp = 0; } // S„É©„É≥„ÇØÂà∞ÈÅî
                }
            },

            battleEndTurnOrder() {
                const b = Model.state.battle; if (!b.active || b.turn !== 'player') return;
                if (b.selectedUnit && b.tempMoved) b.movedUnits.add(b.selectedUnit);
                b.selectedUnit = null; b.tempMoved = false; b.turn = 'enemy'; b.movedUnits.clear();
                View.updateBattleUI(); setTimeout(() => this.enemyBattleTurn(), 800);
            },

            enemyBattleTurn() {
                const b = Model.state.battle; if (!b.active) return;
                Model.state.battle.units.filter(u => u.owner === 'enemy').forEach(e => {
                    const targets = Model.state.battle.units.filter(u => u.owner === 'player');
                    if (targets.length > 0) {
                        const t = targets[0], d = Model.getHexDist(e.r, e.c, t.r, t.c);
                        if (d <= e.range) this.battleAttack(e, t);
                        else {
                            let nR = e.r, nC = e.c;
                            if (e.r > t.r) nR--; else if (e.r < t.r) nR++;
                            if (e.c > t.c) nC--; else if (e.c < t.c) nC++;
                            if (!b.units.some(u => u.r === nR && u.c === nC)) { e.r = nR; e.c = nC; }
                            if (Model.getHexDist(e.r, e.c, t.r, t.c) <= e.range) this.battleAttack(e, t);
                            b.movedUnits.add(e);
                        }
                    }
                });
                this.checkBattleEnd();
                if (b.active) { b.turn = 'player'; b.movedUnits.clear(); View.updateBattleUI(); View.showMessage("„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥„Åß„Åô"); }
            },

            checkBattleEnd() {
                const b = Model.state.battle; if (!b.active) return;
                const pC = b.units.filter(u => u.owner === 'player').length, eC = b.units.filter(u => u.owner === 'enemy').length;
                if (eC === 0) { b.active = false; View.openModal("VICTORY", "ÂãùÂà©ÔºÅ", [{ label: "Á∂öË°å", action: () => this.finishBattle(true) }]); }
                else if (pC === 0) { b.active = false; View.openModal("ÊïóÂåó", "ÂÖ®ÊªÖ„Åó„Åü...", [{ label: "Â∏∞ÈÇÑ", action: () => this.finishBattle(false) }]); }
            },

            finishBattle(win) {
                const pA = Model.state.encounterPlayer;
                pA.hasActed = true; // Êà¶ÈóòÁµÇ‰∫ÜÂæå„Å´Ë°åÂãïÊ∏à„Åø„Å®„Åô„ÇãÔºàÊ¨°„ÅÆ„Çø„Éº„É≥ÈñãÂßãÊôÇ„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„ÇãÔºâ
                if (win) {
                    Model.state.mapUnits = Model.state.mapUnits.filter(u => u !== Model.state.encounterEnemy);
                    // Áîü„ÅçÊÆã„Å£„Åü„É¶„Éã„ÉÉ„Éà„ÇíÂÖ®ÂõûÂæ©„Åï„Åõ„Å¶Âºï„ÅçÁ∂ô„Åê
                    pA.army = Model.state.battle.units.filter(u => u.owner === 'player').map(u => ({ ...u, currentHp: u.hp }));
                } else {
                    // Êú¨Êã†Âú∞ÔºàÁéãÈÉΩÔºâ„Åß„ÅÆÊïóÂåó„ÉªÊí§ÈÄÄ„ÅØÂç≥Â∫ß„Å´„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
                    const atHQ = Math.hypot(pA.x - 150, pA.y - 200) < 45; // c1 (ÁéãÈÉΩ) „ÅÆÂ∫ßÊ®ô
                    if (atHQ) {
                        Model.state.gameCleared = true;
                        View.showEnding(false);
                        return;
                    }

                    // ÊïóÂåóÊôÇ„ÅØ„Éö„Éä„É´„ÉÜ„Ç£„Å®„Åó„Å¶ÂàùÊúü„É¶„Éã„ÉÉ„Éà1‰Ωì„ÅßÂæ©Ê¥ªÔºàHPÂÖ®ÈñãÔºâ
                    pA.army = [{ ...Model.FACTION_UNITS[Model.state.playerMaster.id][0], currentHp: Model.FACTION_UNITS[Model.state.playerMaster.id][0].hp }];
                    const hq = Model.state.castles.find(c => c.id === 'c1');
                    if (hq) {
                        // „ÇÇ„ÅóÁéãÈÉΩ„ÅåÊó¢„Å´Êïµ„Å´Âç†È†ò„Åï„Çå„Å¶„ÅÑ„Åü„ÇâÊïóÂåó
                        if (hq.owner === 'enemy') {
                            Model.state.gameCleared = true;
                            View.showEnding(false);
                            return;
                        }
                        pA.x = hq.x; pA.y = hq.y; pA.targetX = hq.x; pA.targetY = hq.y;
                    }
                }
                Model.state.encounterCooldown = 60; Model.state.battle.active = false; View.changeScreen('map');
            },

            showEscapeConfirm() { View.openModal("Êí§ÈÄÄÁ¢∫Ë™ç", "Êà¶Â†¥„Åã„ÇâÈõ¢ËÑ±„Åó„Åæ„Åô„ÅãÔºü", [{ label: "„ÅØ„ÅÑ", action: () => this.finishBattle(false) }, { label: "„ÅÑ„ÅÑ„Åà", action: () => { } }]); },

            saveGame() {
                const saveState = JSON.parse(JSON.stringify(Model.state));
                saveState.battle.grid = [];
                if (Model.state.battle.movedUnits) {
                    saveState.battle.movedUnitsIndices = [...Model.state.battle.movedUnits].map(u => Model.state.battle.units.indexOf(u));
                }
                localStorage.setItem('bahamut_save', JSON.stringify(saveState));
                View.showMessage("„Ç∑„Çπ„ÉÜ„É†ÔºöÈÄ≤Ë°åÁä∂Ê≥Å„Çí„Çª„Éº„Éñ„Åó„Åæ„Åó„Åü");
            },

            loadGame() {
                const data = localStorage.getItem('bahamut_save');
                if (!data) { View.showMessage("„Ç®„É©„ÉºÔºö„Çª„Éº„Éñ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"); return; }
                const state = JSON.parse(data);
                if (state.battle.movedUnitsIndices) {
                    state.battle.movedUnits = new Set(state.battle.movedUnitsIndices.map(i => state.battle.units[i]));
                } else {
                    state.battle.movedUnits = new Set();
                }
                Model.state = state;
                View.changeScreen(Model.state.currentScreen);
                if (Model.state.currentScreen === 'map') {
                    View.initCanvas();
                } else if (Model.state.currentScreen === 'battle') {
                    this.initBattleGrid();
                }
                if (Model.state.playerMaster) {
                    document.getElementById('master-name').innerText = Model.state.playerMaster.name;
                    document.getElementById('master-name').style.color = Model.state.playerMaster.color;
                    document.getElementById('master-alignment').innerText = Model.state.playerMaster.alignment;
                }
                const turns = Model.state.strategicTurn === 'enemy';
                document.getElementById('turn-text').innerText = turns ? "Enemy Turn" : "Player Turn";
                document.getElementById('turn-text').classList.toggle('text-red-500', turns);
                document.getElementById('btn-end-strategic-turn').classList.toggle('hidden', turns);
                document.getElementById('save-load-group').classList.toggle('hidden', turns);
                View.showMessage("„Ç∑„Çπ„ÉÜ„É†Ôºö„Ç≤„Éº„É†„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü");
            }
        };

        /**
         * TEST SUITE: „Ç∑„Çπ„ÉÜ„É†„ÉÜ„Çπ„Éà
         */
        const TestSuite = {
            logs: [],
            assert(condition, message) {
                this.logs.push(`${condition ? '‚úÖ PASS' : '‚ùå FAIL'}: ${message}`);
                return condition ? 1 : 0;
            },

            runAll() {
                this.logs = [];
                let passed = 0, total = 0;

                console.log("--- Starting System Tests ---");

                // 1. Ë∑ùÈõ¢Ë®àÁÆó„ÅÆ„ÉÜ„Çπ„Éà
                total++; passed += this.assert(Model.getHexDist(0, 0, 0, 1) === 1, "Hex Distance: Adjacent");
                total++; passed += this.assert(Model.getHexDist(0, 0, 2, 2) === 3, "Hex Distance: Diagonal (0,0 to 2,2 is 3 steps)");
                total++; passed += this.assert(Model.getHexDist(0, 0, 5, 0) === 5, "Hex Distance: Far");

                // 2. Â∫ßÊ®ôÂ§âÊèõ„ÅÆ„ÉÜ„Çπ„Éà
                const cube = Model.getCubeCoords(2, 2);
                total++; passed += this.assert(cube.x + cube.y + cube.z === 0, "Cube Coordinates: Sum is zero");

                // 3. Ë≥áÈáëÁÆ°ÁêÜ„Å®ÈõáÁî®Âà∂Èôê„ÅÆ„ÉÜ„Çπ„Éà
                const originalGold = Model.state.gold;
                const originalUnits = [...Model.state.mapUnits];
                const originalMaster = Model.state.playerMaster;

                // „É¢„ÉÉ„ÇØ„Éá„Éº„ÇøË®≠ÂÆö
                Model.state.playerMaster = Model.MASTERS[0]; // knight
                Model.state.gold = 400; // 500GÊú™Ê∫Ä„Å´Ë®≠ÂÆö
                const mockCastle = { x: 0, y: 0, id: 'test-c' };

                Controller.createNewArmy(mockCastle);
                total++; passed += this.assert(Model.state.mapUnits.length === originalUnits.length, "Create Army: Should fail if insufficient gold");

                Model.state.gold = 1000;
                Controller.createNewArmy(mockCastle);
                total++; passed += this.assert(Model.state.mapUnits.length === originalUnits.length + 1, "Create Army: Should succeed if enough gold");
                total++; passed += this.assert(Model.state.gold === 500, "Create Army: Gold should be deducted");

                // ÊúÄÂ§ßÈÉ®ÈöäÊï∞Âà∂Èôê„ÅÆ„ÉÜ„Çπ„Éà
                Model.state.gold = 10000;
                while (Model.state.mapUnits.length < Model.MAX_ARMIES) { Controller.createNewArmy(mockCastle); }
                const countBefore = Model.state.mapUnits.length;
                Controller.createNewArmy(mockCastle);
                total++; passed += this.assert(Model.state.mapUnits.length === countBefore, "Create Army: Should not exceed MAX_ARMIES");

                // 4. ÂèéÂÖ•Ë®àÁÆó„ÅÆ„ÉÜ„Çπ„Éà
                Model.state.gold = 0;
                const originalCastlesIncome = JSON.parse(JSON.stringify(Model.state.castles));
                Model.state.castles = [
                    { owner: 'player' }, { owner: 'player' }, { owner: 'enemy' }
                ];
                Controller.startPlayerTurn();
                // 100(Âü∫Êú¨) + 2(ÂüéÊï∞) * 200 = 500
                total++; passed += this.assert(Model.state.gold === 500, `Income Calculation: Expected 500, got ${Model.state.gold}`);

                // 5. ÂãùÂà©„ÉªÊïóÂåóÂà§ÂÆö„ÅÆ„ÉÜ„Çπ„Éà
                Model.state.gameCleared = false;
                Model.state.castles = [{ owner: 'player' }, { owner: 'neutral' }]; // Êïµ„Åå0
                Controller.checkWinCondition();
                total++; passed += this.assert(Model.state.gameCleared === true, "Win Condition: Enemy castles are zero");

                Model.state.gameCleared = false;
                Model.state.castles = [{ owner: 'enemy' }, { owner: 'neutral' }]; // Ëá™Ëªç„Åå0
                Controller.checkWinCondition();
                total++; passed += this.assert(Model.state.gameCleared === true, "Lose Condition: Player castles are zero");

                // 6. „Çø„Éº„É≥„É™„Çª„ÉÉ„Éà„Å®Ë°åÂãï„Éï„É©„Ç∞„ÅÆ„ÉÜ„Çπ„Éà
                // Êà¶ÈóòÁµÇ‰∫ÜÂæå„ÅÆ„Éï„É©„Ç∞Ë®≠ÂÆö„ÉÜ„Çπ„Éà
                const mockArmy = { hasActed: false };
                Model.state.encounterPlayer = mockArmy;
                Controller.finishBattle(true);
                total++; passed += this.assert(mockArmy.hasActed === true, "Action Flag: Unit should be 'acted' after battle");

                // „Çø„Éº„É≥ÈñãÂßãÊôÇ„ÅÆ„É™„Çª„ÉÉ„Éà„ÉÜ„Çπ„Éà
                Model.state.mapUnits = [
                    { hasActed: true, owner: 'player' },
                    { hasActed: true, owner: 'player' },
                    { hasActed: false, owner: 'enemy' }
                ];
                Controller.startPlayerTurn();
                total++; passed += this.assert(Model.state.mapUnits[0].hasActed === false, "Turn Reset: Player unit 1 should be reset");
                total++; passed += this.assert(Model.state.mapUnits[1].hasActed === false, "Turn Reset: Player unit 2 should be reset");

                // Áí∞Â¢É„ÅÆÂæ©ÂÖÉ
                Model.state.gold = originalGold;
                Model.state.mapUnits = originalUnits;
                Model.state.playerMaster = originalMaster;
                Model.state.castles = originalCastlesIncome;
                Model.state.gameCleared = false;
                Model.state.encounterPlayer = null;

                // ÁµêÊûú„ÅÆË°®Á§∫
                this.logs.forEach(log => console.log(log));
                console.log(`--- Test Results: ${passed}/${total} passed ---`);
                View.showMessage(`„ÉÜ„Çπ„ÉàÂÆå‰∫Ü: ${passed}/${total} ÂêàÊ†º„ÄÇË©≥Á¥∞„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            }
        };

        window.onload = () => { Controller.init(); View.changeScreen('title'); };
        window.onresize = () => { if (Model.state.currentScreen === 'map') View.initCanvas(); };
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legend of Bahamut Strategy - Battle & Move Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

        body {
            font-family: 'DotGothic16', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            margin: 0;
            touch-action: manipulation;
        }

        .hex {
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            transition: all 0.2s;
        }

        .hex-active:hover {
            filter: brightness(1.5);
            cursor: pointer;
        }

        .scanline {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 100;
        }

        .pixel-border {
            border: 4px double #4a5568;
            background: rgba(0, 0, 0, 0.85);
        }

        @keyframes select-pulse {
            0% {
                filter: drop-shadow(0 0 5px cyan);
            }

            50% {
                filter: drop-shadow(0 0 20px cyan);
            }

            100% {
                filter: drop-shadow(0 0 5px cyan);
            }
        }

        .recruit-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="scanline"></div>

    <!-- VIEW: UI Elements -->
    <div id="ui-layer" class="fixed inset-0 z-50 pointer-events-none">

        <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº -->
        <div id="status-bar"
            class="absolute top-4 left-4 right-4 flex justify-between items-start hidden pointer-events-none">
            <div class="bg-black/70 p-4 border-2 border-gray-600 pointer-events-auto shadow-lg">
                <div class="text-xs text-gray-400 text-center uppercase mb-1 font-bold tracking-widest">Commander</div>
                <div id="master-name" class="text-2xl text-yellow-500 text-center font-bold"></div>
                <div id="master-alignment" class="text-sm text-center opacity-70 mt-1 text-white"></div>
            </div>

            <div class="flex flex-col gap-2 items-end">
                <div class="bg-black/70 p-4 border-2 border-gray-600 text-right pointer-events-auto shadow-lg">
                    <div class="flex gap-8 items-center">
                        <div class="text-right">
                            <div class="text-xs text-gray-400 uppercase font-bold text-blue-400">P-Castles</div>
                            <div id="castle-count-display" class="text-2xl text-blue-400 font-bold">1 / 7</div>
                        </div>
                        <div class="text-right border-l border-gray-600 pl-6">
                            <div class="text-xs text-gray-400 uppercase font-bold text-green-400">P-Armies</div>
                            <div id="army-total-display" class="text-2xl text-green-400 font-bold">1 / 8</div>
                        </div>
                        <div class="text-right border-l border-gray-600 pl-6">
                            <div class="text-xs text-gray-400 uppercase font-bold text-yellow-400">P-Gold</div>
                            <div id="gold-amount" class="text-4xl text-yellow-400 font-bold font-mono text-white">500
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <div id="save-load-group" class="flex gap-3">
                        <button onclick="Controller.saveGame()"
                            class="px-6 py-2 bg-green-900 hover:bg-green-700 border-2 border-white text-lg font-bold pointer-events-auto transition-all shadow-xl text-white">„Çª„Éº„Éñ</button>
                        <button onclick="Controller.loadGame()"
                            class="px-6 py-2 bg-blue-900 hover:bg-blue-700 border-2 border-white text-lg font-bold pointer-events-auto transition-all shadow-xl text-white">„É≠„Éº„Éâ</button>
                    </div>
                    <button id="btn-end-strategic-turn" onclick="Controller.endStrategicTurn()"
                        class="px-10 py-3 bg-red-900 hover:bg-red-700 border-2 border-white text-2xl font-bold pointer-events-auto transition-all shadow-xl hidden">„Çø„Éº„É≥ÁµÇ‰∫Ü</button>
                </div>
            </div>
        </div>

        <!-- Âüé„É°„Éã„É•„Éº -->
        <div id="base-menu"
            class="absolute inset-0 bg-black/95 flex items-center justify-center hidden pointer-events-auto p-4 text-white">
            <div class="pixel-border p-8 w-full max-w-6xl max-h-[95vh] overflow-y-auto shadow-[0_0_50px_rgba(0,0,0,1)]">
                <div class="flex justify-between items-start mb-6 border-b border-gray-700 pb-6">
                    <div>
                        <h2 class="text-5xl text-yellow-500 font-bold mb-2" id="base-menu-title">Âüé„ÅÆÂêçÂâç</h2>
                        <div id="castle-stat-panel" class="flex gap-8 text-xl font-bold"></div>
                    </div>
                    <div class="flex flex-col items-end gap-4">
                        <div
                            class="flex items-center gap-4 bg-black/50 p-3 rounded border border-gray-700 shadow-inner">
                            <span class="text-gray-400 text-sm font-bold uppercase">Funds:</span>
                            <span class="text-3xl text-yellow-400 font-bold font-mono"
                                id="menu-gold-display">500G</span>
                        </div>
                        <div class="flex gap-3">
                            <button id="btn-create-army"
                                class="px-8 py-3 bg-purple-900 hover:bg-purple-700 border-2 border-purple-400 text-xl transition-colors disabled:opacity-30 disabled:grayscale font-bold shadow-xl">Êñ∞Ë¶èÈÉ®Èöä„ÇíÁ∑®Êàê
                                (500G)</button>
                            <button onclick="View.toggleBaseMenu()"
                                class="text-gray-400 hover:text-white transition-colors text-5xl p-2">‚úï</button>
                        </div>
                    </div>
                </div>
                <div id="unique-unit-info-panel"
                    class="mb-8 p-6 bg-yellow-900/30 border-2 border-yellow-700/50 rounded-xl flex items-center gap-8 hidden text-white">
                </div>
                <div id="base-menu-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8 text-white"></div>
                <div id="no-unit-message"
                    class="hidden py-24 text-center border-4 border-dashed border-gray-800 rounded-xl text-gray-500 text-2xl font-bold">
                    ÈßêÁïôÈÉ®Èöä„Å™„Åó</div>
            </div>
        </div>

        <!-- ÁµêÊûú„É¢„Éº„ÉÄ„É´ -->
        <div id="modal-layer"
            class="absolute inset-0 bg-black/80 flex items-center justify-center hidden pointer-events-auto text-white">
            <div class="bg-gray-900 border-4 border-double border-white p-12 max-w-lg w-full text-center shadow-2xl">
                <h2 id="modal-title" class="text-5xl font-bold mb-8 text-yellow-500 uppercase">Result</h2>
                <p id="modal-body" class="mb-12 text-2xl leading-relaxed text-gray-200 font-bold"></p>
                <div id="modal-footer" class="flex justify-center gap-8"></div>
            </div>
        </div>


        <!-- ÊúÄÂâçÈù¢„Å´Ë°®Á§∫„Åô„Åπ„ÅçË¶ÅÁ¥† -->
        <div id="top-elements" class="absolute inset-0 pointer-events-none z-[110]">
            <!-- „Çø„Éº„É≥Ë°®Á§∫ -->
            <div id="turn-indicator"
                class="absolute top-4 left-1/2 -translate-x-1/2 px-12 py-2 bg-black/80 border-2 border-white hidden pointer-events-auto shadow-2xl flex flex-col items-center">
                <div id="turn-display" class="text-sm text-yellow-500 font-bold mb-1">TURN 1</div>
                <p id="turn-text" class="text-3xl font-bold tracking-widest text-center uppercase">Player Turn</p>
            </div>

            <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ -->
            <div id="message-box"
                class="absolute bottom-10 left-1/2 -translate-x-1/2 w-4/5 max-w-2xl bg-black/95 border-4 border-double border-gray-500 p-6 opacity-0 transition-opacity pointer-events-auto shadow-2xl">
                <p id="message-text"
                    class="text-xl md:text-2xl leading-relaxed whitespace-pre-wrap text-white font-bold text-center">
                </p>
            </div>
        </div>
    </div>

    <!-- „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
    <div id="screen-ending"
        class="hidden flex flex-col items-center justify-center h-screen bg-black text-white p-8 relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-blue-900/20 to-black pointer-events-none"></div>
        <div id="ending-vfx" class="absolute inset-0 pointer-events-none opacity-50"></div>

        <div class="relative z-10 text-center scale-110">
            <h2 id="ending-title"
                class="text-8xl font-bold mb-12 text-yellow-500 uppercase tracking-tighter drop-shadow-[0_0_30px_rgba(234,179,8,0.5)]">
                VICTORY</h2>
            <div class="pixel-border p-12 mb-16 max-w-3xl bg-black/60 shadow-2xl">
                <p id="ending-body" class="text-3xl leading-relaxed text-gray-200 font-bold"></p>
            </div>
            <button onclick="location.reload()"
                class="px-20 py-8 bg-gradient-to-r from-blue-900 to-blue-700 hover:from-blue-700 hover:to-blue-500 border-4 border-white transition-all text-4xl font-bold shadow-[0_0_50px_rgba(0,0,0,0.5)] hover:scale-105 active:translate-y-1">
                „Çø„Ç§„Éà„É´ÁîªÈù¢„Å∏Êàª„Çã
            </button>
        </div>
    </div>

    <!-- MAIN SCREENS -->
    <div id="screen-title" class="flex flex-col items-center justify-center h-screen relative">
        <h1
            class="text-8xl mb-8 font-bold text-transparent bg-clip-text bg-gradient-to-b from-gray-200 to-gray-600 uppercase tracking-tighter text-center">
            Bahamut Strategy</h1>
        <p class="mb-16 text-3xl text-gray-400 italic font-bold text-center">„Äú Â§ßÈô∏Áµ±‰∏ÄÔºöÊú¨Ê†º„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ „Äú</p>
        <div class="flex gap-4">
            <button onclick="Controller.startFlow()"
                class="px-16 py-6 bg-red-900 hover:bg-red-700 border-2 border-white transition-all text-4xl font-bold shadow-2xl hover:scale-105 text-white">START
                GAME</button>
            <button onclick="Controller.loadGame()"
                class="px-16 py-6 bg-blue-900 hover:bg-blue-700 border-2 border-white transition-all text-4xl font-bold shadow-2xl hover:scale-105 text-white">LOAD
                GAME</button>
        </div>
        <div class="mt-8 flex gap-4 pointer-events-auto">
            <button onclick="TestSuite.runAll()"
                class="px-4 py-2 bg-gray-800 text-gray-500 text-xs hover:text-white border border-gray-700 transition-colors">Run
                System Tests</button>
        </div>
    </div>

    <!-- „Éû„ÉÉ„ÉóÈÅ∏ÊäûÁîªÈù¢ -->
    <div id="screen-map-select" class="hidden flex-col items-center justify-center min-h-screen p-8 bg-black/95">
        <h2 class="text-6xl mb-12 font-bold text-center text-yellow-500 uppercase tracking-widest">Êà¶Âú∞„ÇíÈÅ∏Êäû„Åõ„Çà</h2>
        <div id="map-flow-list" class="grid grid-cols-1 md:grid-cols-3 gap-10 max-w-7xl w-full mb-12"></div>
        <div class="flex justify-center gap-6">
            <button onclick="View.changeScreen('title')"
                class="px-12 py-4 bg-gray-900 hover:bg-gray-700 border-2 border-gray-500 text-2xl font-bold shadow-xl text-white transition-all">Êàª„Çã</button>
        </div>
    </div>

    <div id="screen-select"
        class="hidden flex-col items-center justify-center min-h-screen p-8 bg-black/95 overflow-y-auto">
        <h2 class="text-5xl mb-16 font-bold text-center text-white italic tracking-widest uppercase">„Éû„Çπ„Çø„Éº„ÇíÈÅ∏Êäû„Åõ„Çà</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10 max-w-7xl w-full mb-12"></div>
        <div class="flex justify-center gap-6">
            <button onclick="View.changeScreen('map-select')"
                class="px-12 py-4 bg-gray-900 hover:bg-gray-700 border-2 border-gray-500 text-2xl font-bold shadow-xl text-white transition-all">Êàª„Çã</button>
        </div>
    </div>

    <div id="screen-map" class="hidden relative h-screen bg-green-900/20">
        <canvas id="map-canvas" class="w-full h-full"></canvas>
    </div>

    <div id="screen-battle" class="hidden flex flex-col items-center justify-center h-screen bg-slate-900">
        <div class="mb-8 flex gap-16">
            <div id="p1-stats" class="text-4xl text-blue-400 font-bold uppercase tracking-wider">PLAYER</div>
            <div class="text-white text-2xl font-bold opacity-30 italic self-center">VS</div>
            <div id="p2-stats" class="text-4xl text-red-400 font-bold uppercase tracking-wider">ENEMY</div>
        </div>
        <div id="battle-grid" class="relative scale-110"></div>
        <div class="mt-16 flex gap-10">
            <button id="battle-end-turn-btn" onclick="Controller.battleEndTurnOrder()"
                class="px-12 py-4 bg-blue-800 hover:bg-blue-600 border-2 border-white transition-colors text-2xl font-bold rounded-lg shadow-xl pointer-events-auto text-white">„Çø„Éº„É≥ÁµÇ‰∫Ü</button>
            <button onclick="Controller.showEscapeConfirm()"
                class="px-12 py-4 bg-gray-800 hover:bg-gray-600 border-2 border-white transition-colors text-2xl font-bold rounded-lg shadow-xl pointer-events-auto text-white">Êí§ÈÄÄ</button>
        </div>
    </div>

    <script>
        /**
         * MODEL: ÂÆöÁæ©„Å®Áä∂ÊÖãÁÆ°ÁêÜ
         */
        const Model = {
            MAX_UNITS: 5,
            MAX_ARMIES: 8,
            ARMY_COST: 500,
            UNIT_SPEED: 10.0, // ÈÄ≤Ëªç„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó
            RANK_UP_XP: 50, // „É©„É≥„ÇØ„Ç¢„ÉÉ„Éó„Å´ÂøÖË¶Å„Å™ÁµåÈ®ìÂÄ§
            RANKS: ['E', 'D', 'C', 'B', 'A', 'S'],

            MASTERS: [
                { id: 'knight', name: '„Ç∏„Éº„ÇØ', alignment: 'LAW', color: '#4466ff', emoji: 'üè∞', desc: 'ËÅñÈ®éÂ£´„ÄÇÈò≤Âæ°„Å®ËøëÊé•Êà¶Èóò„Å´ÂÑ™„Çå„Çã„Éê„É©„É≥„ÇπÂûã„ÄÇ' },
                { id: 'mage', name: '„Ç¢„Éº„Ç∑„Çß', alignment: 'NEUTRAL', color: '#44ff66', emoji: 'üßù', desc: 'Â•≥Áéã„ÄÇÈÅ†Ë∑ùÈõ¢È≠îÊ≥ï„Å®Ê©üÂãïÂäõ„ÇíÊåÅ„Å§„Ç®„É´„ÉïËªç„ÄÇ' },
                { id: 'demon', name: '„ÇØ„É™„É†„Çæ„É≥', alignment: 'CHAOS', color: '#ff4444', emoji: 'üëπ', desc: 'È≠îÁéã„ÄÇÂúßÂÄíÁöÑ„Å™ÊîªÊíÉÂäõ„ÅßÊïµ„ÇíÁ≤âÁ†ï„Åô„Çã„ÄÇ' }
            ],

            FACTION_UNITS: {
                'knight': [
                    { id: 'soldier', name: 'ÂÖµÂ£´', emoji: 'üõ°Ô∏è', hp: 40, atk: 14, range: 1, move: 3, cost: 200 },
                    { id: 'paladin', name: 'È®éÂ£´', emoji: 'üèá', hp: 60, atk: 20, range: 1, move: 5, cost: 500 }
                ],
                'mage': [
                    { id: 'elf', name: '„Ç®„É´„Éï', emoji: 'üèπ', hp: 30, atk: 18, range: 3, move: 3, cost: 300 },
                    { id: 'fairy', name: 'Â¶ñÁ≤æ', emoji: 'üßö', hp: 25, atk: 12, range: 2, move: 4, cost: 250 }
                ],
                'demon': [
                    { id: 'imp', name: 'Â∞èÊÇ™È≠î', emoji: 'üëø', hp: 28, atk: 18, range: 1, move: 4, cost: 150 },
                    { id: 'dragon', name: 'Á´ú', emoji: 'üêâ', hp: 95, atk: 32, range: 1, move: 6, cost: 1000 }
                ]
            },

            MAP_TEMPLATES: [
                {
                    id: 'classic', name: '„Éê„Éè„É†„Éº„ÉàÂ§ßÈô∏ (Classic)', desc: 'Ê®ôÊ∫ñÁöÑ„Å™„Éê„É©„É≥„Çπ„ÅÆÂàùÊúü„Éû„ÉÉ„Éó„Åß„Åô„ÄÇ',
                    castles: [
                        { id: 'c1', name: 'ÁéãÈÉΩ', x: 150, y: 200, owner: 'player', captureBonus: 0, uniqueUnit: null, neighbors: ['c3', 'c7'] },
                        { id: 'c2', name: 'ÊöóÈªíÂüé', x: 750, y: 550, owner: 'enemy', captureBonus: 2000, uniqueUnit: 'hell-hound', neighbors: ['c3', 'c5', 'c6'] },
                        { id: 'c6', name: 'Êù±„ÅÆÂ°î', x: 750, y: 150, owner: 'enemy2', captureBonus: 800, uniqueUnit: 'sorcerer', neighbors: ['c2', 'c4'] },
                        { id: 'c3', name: 'Ëá™Áî±ÈÉΩÂ∏Ç', x: 450, y: 350, owner: 'neutral', captureBonus: 500, uniqueUnit: 'guard', neighbors: ['c1', 'c2', 'c4', 'c5'] },
                        { id: 'c4', name: 'Âåó„ÅÆÁ†¶', x: 450, y: 100, owner: 'neutral', captureBonus: 350, uniqueUnit: 'crossbow', neighbors: ['c3', 'c6'] },
                        { id: 'c5', name: 'Âçó„ÅÆÊùë', x: 250, y: 550, owner: 'neutral', captureBonus: 200, uniqueUnit: 'militia', neighbors: ['c2', 'c3'] },
                        { id: 'c7', name: 'Ë•ø„ÅÆÂªÉÂ¢ü', x: 100, y: 450, owner: 'neutral', captureBonus: 400, uniqueUnit: 'ghost', neighbors: ['c1'] }
                    ]
                },
                {
                    id: 'islands', name: 'Áæ§Â≥∂Ë´∏ÂõΩ (Islands)', desc: 'Á¥∞Èï∑„ÅÑ„É´„Éº„Éà„ÅßÊßãÊàê„Åï„Çå„ÅüÊ©üÂãïÂäõ„ÅåË©¶„Åï„Çå„Çã„Éû„ÉÉ„Éó„ÄÇ',
                    castles: [
                        { id: 'c1', name: 'ÁéãÈÉΩ', x: 100, y: 300, owner: 'player', captureBonus: 0, uniqueUnit: null, neighbors: ['c3'] },
                        { id: 'c2', name: 'ÂΩ±„ÅÆÂ≥∂', x: 800, y: 300, owner: 'enemy', captureBonus: 2000, uniqueUnit: 'hell-hound', neighbors: ['c6'] },
                        { id: 'c5', name: 'ÁÇé„ÅÆÈÅãÊ≤≥', x: 650, y: 450, owner: 'enemy2', captureBonus: 300, uniqueUnit: 'sorcerer', neighbors: ['c4', 'c6'] },
                        { id: 'c3', name: 'È¢®„ÅÆÈñ¢ÊâÄ', x: 250, y: 150, owner: 'neutral', captureBonus: 300, uniqueUnit: 'crossbow', neighbors: ['c1', 'c4'] },
                        { id: 'c4', name: '‰∏≠Â§ÆÂ≥∂', x: 450, y: 300, owner: 'neutral', captureBonus: 600, uniqueUnit: 'guard', neighbors: ['c3', 'c5'] },
                        { id: 'c6', name: 'Â¢ÉÁïå„ÅÆÈñÄ', x: 700, y: 150, owner: 'neutral', captureBonus: 400, uniqueUnit: 'pirate', neighbors: ['c2', 'c5'] }
                    ]
                },
                {
                    id: 'ring', name: 'Áí∞Áä∂Â§ßÈô∏ (Ring)', desc: 'Êã†ÁÇπ„ÅåËº™„ÅÆ„Çà„ÅÜ„Å´Áπã„Åå„Å£„ÅüÁâπÊÆä„Å™„Éû„ÉÉ„Éó„ÄÇ',
                    castles: [
                        { id: 'c1', name: 'ÁéãÈÉΩ', x: 450, y: 80, owner: 'player', captureBonus: 0, uniqueUnit: null, neighbors: ['c3', 'c4'] },
                        { id: 'c2', name: 'ÊöóÈªíÂüé', x: 450, y: 520, owner: 'enemy', captureBonus: 2000, uniqueUnit: 'hell-hound', neighbors: ['c5', 'c6'] },
                        { id: 'c3', name: 'Êù±„ÅÆÊ∏Ø', x: 700, y: 200, owner: 'enemy2', captureBonus: 400, uniqueUnit: 'pirate', neighbors: ['c1', 'c5'] },
                        { id: 'c4', name: 'Ë•ø„ÅÆÁ†¶', x: 200, y: 200, owner: 'neutral', captureBonus: 400, uniqueUnit: 'dwarf', neighbors: ['c1', 'c6'] },
                        { id: 'c5', name: 'ÂçóÊù±„ÅÆÂπ≥Âéü', x: 700, y: 400, owner: 'neutral', captureBonus: 400, uniqueUnit: 'berserker', neighbors: ['c3', 'c2'] },
                        { id: 'c6', name: 'ÂçóË•ø„ÅÆÊ£Æ', x: 200, y: 400, owner: 'neutral', captureBonus: 400, uniqueUnit: 'fenrir', neighbors: ['c4', 'c2'] }
                    ]
                }
            ],

            SPECIAL_UNITS: {
                'hell-hound': { id: 'hell-hound', name: '„Ç±„É´„Éô„É≠„Çπ', emoji: 'üêï', hp: 45, atk: 22, range: 1, move: 5, cost: 600, origin: 'ÊöóÈªíÂüé' },
                'guard': { id: 'guard', name: 'ÈáçË£ÖË°õÂÖµ', emoji: 'üíÇ', hp: 80, atk: 18, range: 1, move: 2, cost: 400, origin: 'Ëá™Áî±ÈÉΩÂ∏Ç' },
                'crossbow': { id: 'crossbow', name: 'Âº©ÂÖµ', emoji: 'üèπ', hp: 35, atk: 22, range: 4, move: 2, cost: 550, origin: 'Âåó„ÅÆÁ†¶' },
                'militia': { id: 'militia', name: 'Áæ©ÂãáÂÖµ', emoji: 'üßë‚Äçüåæ', hp: 25, atk: 12, range: 1, move: 3, cost: 100, origin: 'Âçó„ÅÆÊùë' },
                'sorcerer': { id: 'sorcerer', name: 'È≠îÂ∞éÂ∏´', emoji: 'üßô', hp: 40, atk: 28, range: 3, move: 2, cost: 800, origin: 'Êù±„ÅÆÂ°î' },
                'ghost': { id: 'ghost', name: '‰∫°Èúä', emoji: 'üëª', hp: 25, atk: 22, range: 1, move: 6, cost: 350, origin: 'Ë•ø„ÅÆÂªÉÂ¢ü' },
                'pirate': { id: 'pirate', name: 'Êµ∑Ë≥ä', emoji: 'üè¥‚Äç‚ò†Ô∏è', hp: 50, atk: 24, range: 1, move: 4, cost: 450, origin: 'Ë´∏Â≥∂/Ê∏Ø' },
                'dwarf': { id: 'dwarf', name: '„Éâ„ÉØ„Éº„ÉïÂÖµ', emoji: '‚öíÔ∏è', hp: 70, atk: 26, range: 1, move: 2, cost: 600, origin: 'Ë•ø„ÅÆÁ†¶' },
                'berserker': { id: 'berserker', name: 'ÁãÇÊà¶Â£´', emoji: 'ü™ì', hp: 45, atk: 35, range: 1, move: 4, cost: 700, origin: 'Êù±„ÅÆÂπ≥Âéü' },
                'fenrir': { id: 'fenrir', name: 'È≠îÁãº', emoji: 'üê∫', hp: 55, atk: 24, range: 1, move: 6, cost: 650, origin: 'ÂçóË•ø„ÅÆÊ£Æ' }
            },

            state: {
                currentScreen: 'title',
                selectedMapId: 'classic',
                factions: [], // { id, name, gold, master, color, isPlayer, isAlive, hqId }
                mapUnits: [], castles: [], selectedMapUnit: null,
                strategicTurn: 'player', // faction id
                battleUnitA: null, battleUnitB: null, // Units in tactical battle
                globalBattleCooldown: 0, gameCleared: false, turnCount: 0, aiActionStarted: false,
                battle: { active: false, grid: [], units: [], turn: 'player', selectedUnit: null, movedUnits: new Set(), tempMoved: false }
            },

            getCubeCoords(r, c) {
                const x = c - Math.floor(r / 2); const z = r; const y = -x - z;
                return { x, y, z };
            },

            getHexDist(r1, c1, r2, c2) {
                const a = this.getCubeCoords(r1, c1); const b = this.getCubeCoords(r2, c2);
                return Math.max(Math.abs(a.x - b.x), Math.abs(a.y - b.y), Math.abs(a.z - b.z));
            }
        };

        /**
         * VIEW: Ë°®Á§∫Âà∂Âæ°
         */
        const View = {
            canvas: null, ctx: null,

            changeScreen(screenId) {
                document.querySelectorAll('div[id^="screen-"]').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`screen-${screenId}`);
                if (target) target.classList.remove('hidden');
                Model.state.currentScreen = screenId;

                const status = document.getElementById('status-bar');
                const turn = document.getElementById('turn-indicator');
                const player = Model.state.factions.find(f => f.isPlayer);
                if (screenId === 'map' && player) {
                    status.classList.remove('hidden');
                    turn.classList.remove('hidden');
                    document.getElementById('gold-amount').innerText = Math.floor(player.gold);
                } else {
                    status.classList.add('hidden');
                    turn.classList.add('hidden');
                }
                const btn = document.getElementById('btn-end-strategic-turn');
                const saveLoad = document.getElementById('save-load-group');
                const isPlayerTurn = Model.state.strategicTurn === 'player';

                if (screenId === 'map') {
                    if (isPlayerTurn) {
                        btn.classList.remove('hidden');
                        saveLoad.classList.remove('hidden');
                    } else {
                        btn.classList.add('hidden');
                        saveLoad.classList.add('hidden');
                    }
                    this.initCanvas();
                } else {
                    btn.classList.add('hidden');
                    saveLoad.classList.add('hidden');
                }
            },

            toggleSettings() {
                const el = document.getElementById('screen-settings');
                if (el.classList.contains('hidden')) {
                    this.renderSettings();
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            },

            renderSettings() {
                const list = document.getElementById('map-select-list');
                list.innerHTML = Model.MAP_TEMPLATES.map(t => `
                    <div onclick="Controller.setMap('${t.id}')" 
                         class="p-6 border-2 transition-all cursor-pointer rounded-xl ${Model.state.selectedMapId === t.id ? 'border-yellow-500 bg-yellow-900/20' : 'border-gray-700 hover:border-gray-500 bg-black/40'}">
                        <div class="text-2xl font-bold mb-2 ${Model.state.selectedMapId === t.id ? 'text-yellow-500' : 'text-white'}">${t.name}</div>
                        <p class="text-sm text-gray-400">${t.desc}</p>
                    </div>
                `).join('');
            },

            renderMapFlow() {
                const list = document.getElementById('map-flow-list');
                list.innerHTML = Model.MAP_TEMPLATES.map(t => `
                    <div onclick="Controller.selectMapAndNext('${t.id}')" 
                         class="p-10 border-4 border-gray-700 hover:border-yellow-500 transition-all cursor-pointer rounded-2xl bg-gray-900 shadow-2xl hover:scale-105">
                        <div class="text-4xl font-bold mb-6 text-white text-center">${t.name}</div>
                        <p class="text-xl text-gray-400 text-center leading-relaxed mb-4">${t.desc}</p>
                        <div class="text-center text-yellow-500 font-bold uppercase tracking-widest text-sm">Click to Select</div>
                    </div>
                `).join('');
            },

            showMessage(text) {
                const box = document.getElementById('message-box');
                const txt = document.getElementById('message-text');
                txt.innerText = text;
                box.style.opacity = '1';
                if (window.msgTimer) clearTimeout(window.msgTimer);
                window.msgTimer = setTimeout(() => { box.style.opacity = '0'; }, 3500);
            },

            openModal(title, body, buttons) {
                const modal = document.getElementById('modal-layer');
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerText = body;
                const footer = document.getElementById('modal-footer');
                footer.innerHTML = '';
                buttons.forEach(btn => {
                    const b = document.createElement('button');
                    b.className = "px-10 py-4 bg-blue-700 hover:bg-blue-600 border-2 border-white text-2xl transition-colors font-bold rounded-lg shadow-lg text-white";
                    b.innerText = btn.label;
                    b.onclick = () => { modal.classList.add('hidden'); btn.action(); };
                    footer.appendChild(b);
                });
                modal.classList.remove('hidden');
            },

            showEnding(isWin) {
                const screen = document.getElementById('screen-ending');
                const title = document.getElementById('ending-title');
                const body = document.getElementById('ending-body');

                if (isWin) {
                    title.innerText = "VICTORY";
                    title.className = "text-8xl font-bold mb-12 text-yellow-500 uppercase tracking-tighter drop-shadow-[0_0_30px_rgba(234,179,8,0.5)]";
                    body.innerText = "ÊïµÂã¢Âäõ„ÅÆÊã†ÁÇπ„Çí„Åô„Åπ„Å¶Âà∂Âúß„Åó„ÄÅ„Éê„Éè„É†„Éº„ÉàÂ§ßÈô∏„Å´Áúü„ÅÆÂπ≥Âíå„ÅåË®™„Çå„Åü„ÄÇ„ÅÇ„Å™„Åü„ÅÆÂêç„ÅØ‰ºùË™¨„Å®„Å™„Çä„ÄÅÊ∞∏„ÅèË™û„ÇäÁ∂ô„Åå„Çå„Çã„Å†„Çç„ÅÜ„ÄÇ";
                } else {
                    title.innerText = "DEFEAT";
                    title.className = "text-8xl font-bold mb-12 text-red-600 uppercase tracking-tighter drop-shadow-[0_0_30px_rgba(220,38,38,0.5)]";
                    body.innerText = "ÂÖ®„Å¶„ÅÆÊã†ÁÇπ„ÇíÂ§±„ÅÑ„ÄÅÈáéÊúõ„ÅØÊΩ∞„Åà„Åü„ÄÇÂ§ßÈô∏„ÅÆÊ≠¥Âè≤„ÅØÂãùËÄÖ„Å´„Çà„Å£„Å¶Êõ∏„ÅçÊèõ„Åà„Çâ„Çå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂêç„ÅØÈóá„Å∏„Å®Ê∂à„Åà„Å¶„ÅÑ„Å£„Åü...";
                }

                this.changeScreen('ending');
            },

            initCanvas() {
                const canvas = document.getElementById('map-canvas');
                if (!canvas) return;
                const newCanvas = canvas.cloneNode(true);
                canvas.parentNode.replaceChild(newCanvas, canvas);
                newCanvas.width = window.innerWidth;
                newCanvas.height = window.innerHeight;
                this.ctx = newCanvas.getContext('2d');
                this.canvas = newCanvas;

                newCanvas.addEventListener('mousedown', Controller.handleMapClick);
                newCanvas.addEventListener('contextmenu', Controller.handleMapRightClick);
                requestAnimationFrame(() => this.renderMapLoop());
            },

            renderMapLoop() {
                if (Model.state.currentScreen !== 'map' || !this.ctx) return;
                const ctx = this.ctx;
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

                const playerFaction = Model.state.factions.find(f => f.isPlayer);
                if (!playerFaction) return; // Âã¢Âäõ„ÅåÂàùÊúüÂåñ„Åï„Çå„ÇãÂâç„ÅØÊèèÁîª„Çí„Çπ„Ç≠„ÉÉ„Éó

                document.getElementById('castle-count-display').innerText = `${Model.state.castles.filter(c => c.owner === playerFaction.id).length} / ${Model.state.castles.length}`;
                document.getElementById('army-total-display').innerText = `${Model.state.mapUnits.filter(u => u.owner === playerFaction.id).length} / ${Model.MAX_ARMIES}`;
                document.getElementById('gold-amount').innerText = Math.floor(playerFaction.gold);
                // ÊïµËªç„Ç¥„Éº„É´„ÉâË°®Á§∫„ÅØÂªÉÊ≠¢ÔºàÂêÑÊã†ÁÇπ„ÅßÁ¢∫Ë™çÔºâ
                document.getElementById('turn-display').innerText = `TURN ${Model.state.turnCount}`;

                ctx.setLineDash([10, 5]); ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 4;
                Model.state.castles.forEach(c => {
                    c.neighbors.forEach(nId => {
                        const n = Model.state.castles.find(nc => nc.id === nId);
                        if (n) { ctx.beginPath(); ctx.moveTo(c.x, c.y); ctx.lineTo(n.x, n.y); ctx.stroke(); }
                    });
                });
                ctx.setLineDash([]);

                Model.state.castles.forEach(c => {
                    ctx.font = '50px serif'; ctx.textAlign = 'center'; ctx.fillText('üè∞', c.x, c.y);
                    ctx.font = '24px DotGothic16';
                    const faction = Model.state.factions.find(f => f.id === c.owner);
                    ctx.fillStyle = faction ? faction.color : '#aaaaaa';
                    ctx.fillText(c.name, c.x, c.y + 40);

                    ctx.font = '16px DotGothic16';
                    const ownerName = faction ? faction.master.name : '‰∏≠Á´ã';
                    ctx.fillText(ownerName, c.x, c.y + 65);

                    // HQÂà§ÂÆö
                    const isHQ = Model.state.factions.some(f => f.hqId === c.id && f.isAlive);
                    if (isHQ) {
                        ctx.font = 'bold 24px DotGothic16';
                        ctx.fillStyle = '#FFD700'; // Gold
                        ctx.shadowBlur = 10; ctx.shadowColor = 'rgba(255,215,0,0.5)';
                        ctx.fillText('üëëHQ', c.x, c.y - 60);
                        ctx.shadowBlur = 0;
                    }

                    // Êà¶ÂäõË°®Á§∫
                    const unitsAtCastle = Model.state.mapUnits.filter(u => u.owner === c.owner && Math.hypot(u.x - c.x, u.y - c.y) < 45);
                    const totalAtk = unitsAtCastle.reduce((sum, u) => sum + u.army.reduce((aSum, unit) => aSum + unit.atk, 0), 0);
                    const totalHp = unitsAtCastle.reduce((sum, u) => sum + u.army.reduce((aSum, unit) => aSum + unit.currentHp, 0), 0);
                    if (totalAtk > 0 || totalHp > 0) {
                        ctx.font = 'bold 16px DotGothic16';
                        ctx.fillStyle = '#ffffff';
                        ctx.shadowBlur = 4; ctx.shadowColor = 'black';
                        ctx.fillText(`‚öí${totalAtk} ‚ù§${totalHp}`, c.x, c.y - 45);
                        ctx.shadowBlur = 0;
                    }
                });

                Model.state.mapUnits.forEach(u => {
                    const isStationed = Model.state.castles.some(c => Math.hypot(u.x - c.x, u.y - c.y) < 30) && !u.isMoving;
                    if (isStationed && u !== Model.state.selectedMapUnit) return;

                    ctx.font = '40px serif';
                    if (u === Model.state.selectedMapUnit) { ctx.shadowBlur = 30; ctx.shadowColor = 'cyan'; }
                    ctx.globalAlpha = (u.owner === 'player' && u.hasActed) ? 0.4 : 1.0;
                    ctx.fillText(u.emoji, u.x, u.y);
                    ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;
                });

                requestAnimationFrame(() => this.renderMapLoop());
            },

            toggleBaseMenu(castle = null) {
                const el = document.getElementById('base-menu');
                if (el.classList.contains('hidden')) {
                    if (castle) this.renderBaseMenu(castle);
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            },

            renderBaseMenu(castle) {
                const castleOwner = Model.state.factions.find(f => f.id === castle.owner);
                const playerFaction = Model.state.factions.find(f => f.isPlayer);
                const sP = Model.state.mapUnits.filter(u => u.owner === playerFaction.id && Math.hypot(u.x - castle.x, u.y - castle.y) < 45);
                const sE = Model.state.mapUnits.filter(u => u.owner !== playerFaction.id && Math.hypot(u.x - castle.x, u.y - castle.y) < 45);

                const isHQ = Model.state.factions.some(f => f.hqId === castle.id && f.isAlive);
                document.getElementById('base-menu-title').innerHTML = castle.name + (isHQ ? ' <span class="bg-yellow-600 text-white text-sm px-3 py-1 rounded-full align-middle ml-4 border border-yellow-400 font-bold shadow-lg">üëëÊú¨Êã†Âú∞</span>' : '');
                const ownerGold = castleOwner ? Math.floor(castleOwner.gold) : 0;
                document.getElementById('menu-gold-display').innerText = `${ownerGold}G (${castleOwner ? castleOwner.name : '‰∏≠Á´ã'})`;

                const ownerDisplay = castleOwner ? `<span style="color:${castleOwner.color}">${castleOwner.master.name}</span>` : '<span class="text-gray-500">‰∏≠Á´ã</span>';
                const ownerType = castle.owner === playerFaction.id ? 'ÔºàËá™ËªçÈ†òÔºâ' : (castle.owner === 'neutral' ? '' : 'ÔºàÊïµÂØæÂã¢ÂäõÔºâ');
                const count = Model.state.mapUnits.filter(u => u.owner === castle.owner && Math.hypot(u.x - castle.x, u.y - castle.y) < 45).length;

                document.getElementById('castle-stat-panel').innerHTML = `
                    <div>ÊîØÈÖçÂã¢Âäõ: ${ownerDisplay}${ownerType}</div>
                    <div>ÈßêÁïôÈÉ®ÈöäÊï∞: <span class="text-white">${count}</span></div>
                `;

                const uniquePanel = document.getElementById('unique-unit-info-panel');
                if (castle.uniqueUnit) {
                    const u = Model.SPECIAL_UNITS[castle.uniqueUnit];
                    uniquePanel.classList.remove('hidden');
                    uniquePanel.innerHTML = `<div class="text-7xl">${u.emoji}</div><div><div class="text-yellow-500 font-bold text-3xl">Êã†ÁÇπÂõ∫ÊúâÂÖµ: ${u.name}</div><div class="text-xl text-gray-200 mt-2 uppercase font-bold text-white">HP:${u.hp} / ATK:${u.atk} / MOVE:${u.move} / RNG:${u.range} / COST:${u.cost}G</div></div>`;
                } else { uniquePanel.classList.add('hidden'); }

                const createBtn = document.getElementById('btn-create-army');
                createBtn.disabled = castle.owner !== playerFaction.id || playerFaction.gold < Model.ARMY_COST || Model.state.mapUnits.filter(u => u.owner === playerFaction.id).length >= Model.MAX_ARMIES;
                createBtn.onclick = () => Controller.createNewArmy(castle);

                const menuContent = document.getElementById('base-menu-content');
                const noMsg = document.getElementById('no-unit-message');
                menuContent.innerHTML = '';

                if (castle.owner === playerFaction.id) {
                    if (sP.length > 0) {
                        noMsg.classList.add('hidden');
                        sP.forEach(unit => {
                            const card = document.createElement('div');
                            card.className = "bg-gray-800/80 border-2 border-gray-700 p-8 rounded-2xl shadow-2xl mb-4 text-white";
                            card.innerHTML = `
                                <div class="flex justify-between items-center mb-8 border-b border-gray-600 pb-4">
                                    <div class="flex items-center gap-6"><span class="text-6xl">${unit.emoji}</span><span class="text-3xl font-bold text-blue-300">${unit.isMaster ? '‰∏ªËªç' : 'Âà•ÂÉçÈöä'}</span></div>
                                    <span class="text-xl font-bold font-mono">ÊßãÊàê: ${unit.army.length} / ${Model.MAX_UNITS}</span>
                                </div>
                                <div class="grid grid-cols-1 gap-10">
                                    <div class="bg-black/50 p-6 rounded-xl border border-blue-900/30">
                                        <p class="text-2xl text-blue-400 mb-6 font-bold border-b border-blue-900/50 pb-2 uppercase tracking-widest text-center">„É¶„Éã„ÉÉ„ÉàÈõáÁî®„ÉªÁ∑®Êàê</p>
                                        <div class="flex flex-col gap-6">
                                            <div>
                                                <p class="text-sm text-gray-400 mb-4 font-bold uppercase tracking-widest">Ë£úÂÖÖ„É¶„Éã„ÉÉ„ÉàÔºàÊñ∞Ë¶èÈõáÁî®Ôºâ</p>
                                                <div class="grid grid-cols-1 gap-4 mb-8">
                                                    ${(() => {
                                    const factionUnits = Model.FACTION_UNITS[playerFaction.master.id];
                                    let options = [...factionUnits];
                                    if (castle.uniqueUnit) {
                                        const spec = Model.SPECIAL_UNITS[castle.uniqueUnit];
                                        if (spec) options.push(spec);
                                    }
                                    return options.map(ut => this.recruitItemHTML(ut, unit, castle)).join('');
                                })()}
                                                </div>
                                            </div>
                                            <div class="pt-8 border-t border-gray-700">
                                                <p class="text-sm text-gray-400 mb-4 font-bold uppercase tracking-widest">Á∑®ÊàêÊ∏à„Åø„É¶„Éã„ÉÉ„ÉàÔºàË©≥Á¥∞„ÉªÂº∑ÂåñÔºâ</p>
                                                <div class="flex flex-col gap-6">
                                                    ${unit.army.map((u, i) => `
                                                        <div class="bg-gray-900 p-4 border border-gray-700 rounded-lg">
                                                            <div class="flex justify-between items-center mb-4">
                                                                <div class="flex items-center gap-4">
                                                                    <span class="text-5xl">${u.emoji}</span>
                                                                    <div>
                                                                        <div class="text-2xl font-bold">${u.name} <span class="text-yellow-500 ml-2 text-xl">RANK ${Model.RANKS[u.rank || 0]}</span></div>
                                                                        <div class="text-sm text-gray-400">Á∑¥Â∫¶: ${u.rank === 5 ? 'MAX' : (u.xp || 0) + ' / ' + Model.RANK_UP_XP}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="text-right">
                                                                    <div class="text-green-400 font-bold">HP: ${u.currentHp}/${u.hp}</div>
                                                                    <div class="text-red-400 font-bold">ATK: ${u.atk}</div>
                                                                </div>
                                                            </div>
                                                            <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden mb-4">
                                                                <div class="h-full bg-yellow-500" style="width:${u.rank === 5 ? 100 : ((u.xp || 0) / Model.RANK_UP_XP) * 100}%"></div>
                                                            </div>
                                                            <div class="flex gap-4">
                                                                <button onclick="Controller.enhanceUnit('${unit.id}', ${i}, 'hp', '${castle.id}')" class="flex-1 py-2 bg-green-900/50 border border-green-700 hover:bg-green-700 text-sm font-bold uppercase transition-colors text-white">HP+10(100G)</button>
                                                                <button onclick="Controller.enhanceUnit('${unit.id}', ${i}, 'atk', '${castle.id}')" class="flex-1 py-2 bg-red-900/50 border border-red-700 hover:bg-red-700 text-sm font-bold uppercase transition-colors text-white">ATK+3(150G)</button>
                                                            </div>
                                                        </div>`).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            menuContent.appendChild(card);
                        });
                    } else {
                        noMsg.classList.remove('hidden');
                        noMsg.innerText = "ÈßêÁïôÈÉ®Èöä„Å™„Åó";
                    }
                } else {
                    if (sE.length > 0) {
                        noMsg.classList.add('hidden');
                        sE.forEach(unit => {
                            const card = document.createElement('div');
                            const owner = Model.state.factions.find(f => f.id === unit.owner);
                            card.className = "bg-red-900/20 border-2 border-red-700/50 p-8 rounded-2xl shadow-2xl mb-4 text-white";
                            card.innerHTML = `
                                <div class="flex justify-between items-center mb-8 border-b border-red-800/50 pb-4">
                                    <div class="flex items-center gap-6"><span class="text-6xl">${unit.emoji}</span><span class="text-3xl font-bold text-red-400">${owner ? owner.name : 'ÊïµËªç'}</span></div>
                                    <span class="text-xl font-bold font-mono">ÊßãÊàê: ${unit.army.length} / ${Model.MAX_UNITS}</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${unit.army.map(u => `
                                        <div class="bg-black/40 p-4 border border-red-900/20 rounded-lg flex justify-between items-center">
                                            <div class="flex items-center gap-4">
                                                <span class="text-5xl">${u.emoji}</span>
                                                <div>
                                                    <div class="text-2xl font-bold text-red-200">${u.name}</div>
                                                    <div class="text-sm text-yellow-600 font-bold uppercase">RANK ${Model.RANKS[u.rank || 0]}</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-green-500 font-bold">HP: ${u.currentHp}/${u.hp}</div>
                                                <div class="text-red-500 font-bold">ATK: ${u.atk}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                            menuContent.appendChild(card);
                        });
                    } else {
                        noMsg.classList.remove('hidden');
                        noMsg.innerText = "Èò≤Ë°õÈÉ®Èöä„ÅØ„ÅÑ„Åæ„Åõ„Çì";
                    }
                }
            },

            recruitItemHTML(ut, unit, castle) {
                const playerFaction = Model.state.factions.find(f => f.isPlayer);
                const can = playerFaction.gold >= ut.cost;
                const isFull = unit.army.length >= Model.MAX_UNITS;
                const dis = isFull || !can || castle.owner !== playerFaction.id;
                const lbl = isFull ? "Ê∫ÄÂì°" : `${ut.cost}G`;
                return `<div class="recruit-item flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/10 cursor-pointer transition-colors" 
                    onclick="View.showMessage('„Äê${ut.name}„Äë HP:${ut.hp} / ATK:${ut.atk} / RNG:${ut.range} / MOVE:${ut.move}')">
                    <div class="flex items-center gap-6">
                        <span class="text-6xl">${ut.emoji}</span>
                        <div>
                            <div class="text-3xl font-bold text-white">${ut.name}</div>
                            <div class="text-sm text-blue-400 font-bold uppercase font-mono">„Çπ„Éö„ÉÉ„ÇØ„ÇíË°®Á§∫ (Click)</div>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); Controller.recruitUnit('${unit.id}', '${ut.id}', '${castle.id}')" 
                        class="px-10 py-4 bg-blue-900 border-2 border-blue-400 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-2xl font-bold shadow-2xl active:translate-y-1 text-white" 
                        ${dis ? 'disabled' : ''}>${lbl}</button>
                </div>`;
            },

            updateBattleUI() {
                const b = Model.state.battle;
                b.grid.forEach(cell => { cell.el.innerHTML = ''; cell.el.classList.remove('bg-blue-900/40', 'bg-red-900/40', 'ring-4', 'ring-white'); });
                b.units.forEach(u => {
                    const cell = b.grid.find(g => g.r === u.r && g.c === u.c);
                    if (cell) {
                        const div = document.createElement('div'); div.className = "relative flex flex-col items-center justify-center pointer-events-none w-full h-full";
                        div.innerHTML = `
                            <div class="flex items-center gap-1 mb-1">
                                <span class="text-4xl shadow-black drop-shadow-md">${u.emoji}</span>
                                <span class="text-[10px] text-yellow-500 font-bold bg-black/50 px-1 rounded">${Model.RANKS[u.rank || 0]}</span>
                            </div>
                            <div class="w-12 h-1.5 bg-gray-900 border border-gray-600 rounded-full overflow-hidden shadow-sm">
                                <div class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-300" style="width:${Math.max(0, (u.currentHp / u.hp) * 100)}%"></div>
                            </div>`;
                        if (b.movedUnits.has(u)) div.style.opacity = "0.4";
                        cell.el.appendChild(div);
                    }
                });
                if (b.selectedUnit) {
                    const s = b.selectedUnit;
                    const sc = b.grid.find(g => g.r === s.r && g.c === s.c);
                    if (sc) sc.el.classList.add('ring-4', 'ring-white');
                    b.grid.forEach(cell => {
                        const d = Model.getHexDist(s.r, s.c, cell.r, cell.c);
                        if (!b.tempMoved && d > 0 && d <= s.move && !b.units.some(u => u.r === cell.r && u.c === cell.c)) cell.el.classList.add('bg-blue-900/40');
                        if (!(s.range > 1 && b.tempMoved) && d > 0 && d <= s.range) cell.el.classList.add('bg-red-900/40');
                    });
                }
                const btn = document.getElementById('battle-end-turn-btn');
                if (btn) btn.disabled = (b.turn !== 'player');
            }
        };

        /**
         * CONTROLLER: Âà∂Âæ°„É≠„Ç∏„ÉÉ„ÇØ
         */
        const Controller = {
            init() { setInterval(() => this.updateLogic(), 50); },

            startFlow() {
                View.changeScreen('map-select');
                View.renderMapFlow();
            },

            selectMapAndNext(id) {
                Model.state.selectedMapId = id;
                this.showMasterSelection();
            },

            showMasterSelection() {
                View.changeScreen('select');
                const container = document.querySelector('#screen-select div');
                container.innerHTML = Model.MASTERS.map(m => `
                    <div class="bg-gray-800 border-2 border-gray-600 p-10 hover:border-white cursor-pointer flex flex-col items-center transition-transform hover:scale-105 shadow-2xl text-white" 
                         onclick="Controller.selectMaster('${m.id}')">
                        <div class="text-9xl mb-8">${m.emoji}</div>
                        <div class="text-4xl font-bold mb-4" style="color:${m.color}">${m.name}</div>
                        <p class="text-xl text-center text-gray-400 font-bold">${m.desc}</p>
                    </div>`).join('');
            },

            selectMaster(id) {
                const playerMaster = Model.MASTERS.find(m => m.id === id);
                const others = Model.MASTERS.filter(m => m.id !== id);

                // Âã¢Âäõ„ÅÆÂàùÊúüÂåñ
                Model.state.factions = [
                    { id: 'player', name: 'Ëá™Ëªç', gold: 500, master: playerMaster, color: '#44aaff', isPlayer: true, isAlive: true, hqId: 'c1' },
                    { id: 'enemy', name: 'ÊïµËªç', gold: 500, master: others[0], color: '#ff4444', isPlayer: false, isAlive: true, hqId: 'c2' },
                    { id: 'enemy2', name: 'Á¨¨‰∫åÊïµËªç', gold: 500, master: others[1], color: '#ff44ff', isPlayer: false, isAlive: true, hqId: (Model.state.selectedMapId === 'classic' ? 'c6' : (Model.state.selectedMapId === 'islands' ? 'c5' : 'c3')) }
                ];

                document.getElementById('master-name').innerText = playerMaster.name;
                document.getElementById('master-name').style.color = playerMaster.color;
                document.getElementById('master-alignment').innerText = playerMaster.alignment;

                // ÈÅ∏Êäû„Åï„Çå„Åü„Éû„ÉÉ„Éó„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ„Ç≥„Éî„Éº„Åó„Å¶ÂàùÊúüÂåñ
                const template = Model.MAP_TEMPLATES.find(t => t.id === Model.state.selectedMapId) || Model.MAP_TEMPLATES[0];
                Model.state.castles = JSON.parse(JSON.stringify(template.castles));

                Model.state.mapUnits = Model.state.factions.map(f => {
                    const hq = Model.state.castles.find(c => c.id === f.hqId);
                    return {
                        id: f.id + '-master', owner: f.id, x: hq.x, y: hq.y, targetX: hq.x, targetY: hq.y,
                        emoji: f.master.emoji,
                        army: Model.FACTION_UNITS[f.master.id].map(u => ({ ...u, currentHp: u.hp, rank: 0, xp: 0 })),
                        isMaster: f.isPlayer, hasActed: false, isMoving: false
                    };
                });

                View.changeScreen('map');
            },

            setMap(id) {
                Model.state.selectedMapId = id;
                View.renderSettings();
            },

            updateLogic() {
                if (Model.state.currentScreen !== 'map') return;

                Model.state.mapUnits.forEach(u => {
                    const dx = u.targetX - u.x, dy = u.targetY - u.y, dist = Math.hypot(dx, dy);
                    if (dist > Model.UNIT_SPEED) { u.x += dx / dist * Model.UNIT_SPEED; u.y += dy / dist * Model.UNIT_SPEED; }
                    else { u.x = u.targetX; u.y = u.targetY; u.isMoving = false; }
                });

                if (Model.state.globalBattleCooldown > 0) Model.state.globalBattleCooldown--;
                if (Model.state.globalBattleCooldown <= 0 && !Model.state.gameCleared) {
                    for (let i = 0; i < Model.state.mapUnits.length; i++) {
                        for (let j = i + 1; j < Model.state.mapUnits.length; j++) {
                            const u1 = Model.state.mapUnits[i], u2 = Model.state.mapUnits[j];
                            if (u1.owner !== u2.owner && Math.hypot(u1.x - u2.x, u1.y - u2.y) < 30) {
                                u1.isMoving = false; u2.isMoving = false;

                                const playerFaction = Model.state.factions.find(f => f.isPlayer);
                                if (u1.owner === playerFaction.id || u2.owner === playerFaction.id) {
                                    Model.state.battleUnitA = (u1.owner === playerFaction.id) ? u1 : u2;
                                    Model.state.battleUnitB = (u1.owner === playerFaction.id) ? u2 : u1;
                                    this.startBattle();
                                } else {
                                    // AI vs AI: „Ç™„Éº„Éà„Éê„Éà„É´Âá¶ÁêÜ
                                    this.autoResolveBattle(u1, u2);
                                }
                                return;
                            }
                        }
                    }
                }

                Model.state.castles.forEach(c => {
                    const unitsOnCastle = Model.state.mapUnits.filter(u => Math.hypot(u.x - c.x, u.y - c.y) < 40);
                    const playerFaction = Model.state.factions.find(f => f.isPlayer);
                    const currentGuard = unitsOnCastle.find(u => u.owner === c.owner);

                    if (!currentGuard) {
                        const playerUnit = unitsOnCastle.find(u => u.owner === playerFaction.id && !u.isMoving);
                        const enemyUnit = unitsOnCastle.find(u => u.owner !== playerFaction.id && !u.isMoving); // Any non-player unit

                        if (playerUnit && !enemyUnit && c.owner !== playerFaction.id) {
                            playerFaction.gold += c.captureBonus;
                            c.captureBonus = 0; // „Éú„Éº„Éä„ÇπÂèñÂæóÊ∏à„Åø
                            c.owner = playerFaction.id; View.showMessage(`${c.name}Âà∂ÂúßÔºÅ`);

                            // ÊïµÊú¨Êã†Âú∞Èô•ËêΩ„Å´„Çà„ÇãÈôç‰ºè
                            const capturedFaction = Model.state.factions.find(f => f.hqId === c.id);
                            if (capturedFaction && !capturedFaction.isPlayer && capturedFaction.isAlive) {
                                View.showMessage(`${capturedFaction.name}„ÅåÈô•ËêΩÔºÅ ÊïµËªç„ÅØÈôç‰ºè„Åó„Åæ„Åó„Åü„ÄÇ`);
                                capturedFaction.isAlive = false;
                                Model.state.mapUnits = Model.state.mapUnits.filter(u => u.owner !== capturedFaction.id);
                                Model.state.castles.forEach(cas => { if (cas.owner === capturedFaction.id) cas.owner = playerFaction.id; });
                            }

                            this.checkWinCondition();
                        } else if (enemyUnit && !playerUnit && c.owner !== enemyUnit.owner) {
                            const captorFaction = Model.state.factions.find(f => f.id === enemyUnit.owner);
                            const previousOwnerId = c.owner;

                            if (captorFaction) captorFaction.gold += c.captureBonus;
                            c.captureBonus = 0;
                            c.owner = captorFaction.id;

                            // Êú¨Êã†Âú∞Èô•ËêΩÂà§ÂÆö
                            const defeatedFaction = Model.state.factions.find(f => f.id === previousOwnerId && f.hqId === c.id);
                            if (defeatedFaction && !defeatedFaction.isPlayer) {
                                View.showMessage(`${defeatedFaction.name}„ÅåÈô•ËêΩÔºÅ ÂãùÂà©„Åó„Åü${captorFaction.name}„ÅåÂÖ®„Å¶„ÅÆÈ†òÂú∞„ÇíÂê∏Âèé„Åó„Åæ„Åó„Åü„ÄÇ`);
                                defeatedFaction.isAlive = false;
                                Model.state.mapUnits = Model.state.mapUnits.filter(u => u.owner !== defeatedFaction.id);
                                Model.state.castles.forEach(cas => { if (cas.owner === defeatedFaction.id) cas.owner = captorFaction.id; });
                            }

                            // „Éó„É¨„Ç§„É§„ÉºÊú¨Êã†Âú∞ÔºàÁéãÈÉΩÔºâÈô•ËêΩ„Å´„Çà„ÇãÊïóÂåó
                            if (c.id === playerFaction.hqId && c.owner !== playerFaction.id) {
                                Model.state.gameCleared = true;
                                View.showEnding(false);
                                return;
                            }

                            this.checkWinCondition();
                        }
                    }
                });

                // „Çø„Éº„É≥ÈÅ∑Áßª„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                if (Model.state.strategicTurn !== 'player' && Model.state.aiActionStarted) {
                    const anyMoving = Model.state.mapUnits.some(u => u.isMoving);
                    const battleActive = Model.state.currentScreen === 'battle';
                    const encounterWaiting = Model.state.globalBattleCooldown > 0;

                    if (!anyMoving && !battleActive && !encounterWaiting) {
                        this.startNextFactionTurn();
                    }
                }
            },

            checkWinCondition() {
                if (Model.state.gameCleared) return;
                const playerFaction = Model.state.factions.find(f => f.isPlayer);
                const pOwned = Model.state.castles.filter(c => c.owner === playerFaction.id).length;
                const activeEnemyFactions = Model.state.factions.filter(f => !f.isPlayer && f.isAlive);

                if (activeEnemyFactions.length === 0) {
                    Model.state.gameCleared = true;
                    setTimeout(() => View.showEnding(true), 1500); // Èôç‰ºèÊºîÂá∫„ÇíË¶ã„Åõ„Çã„Åü„ÇÅÂ∞ë„ÅóÂæÖ„Å§
                } else if (pOwned === 0) {
                    Model.state.gameCleared = true;
                    View.showEnding(false);
                }
            },

            handleMapClick(e) {
                if (e.button !== 0 || Model.state.strategicTurn !== 'player' || Model.state.gameCleared) return;
                const rect = View.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;

                // 1. „Åô„Åß„Å´ÈÉ®Èöä„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åæ„ÅöÁßªÂãïÂÖàÔºàÊã†ÁÇπÔºâ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Åã„ÇíÁ¢∫Ë™ç
                if (Model.state.selectedMapUnit) {
                    const castle = Model.state.castles.find(c => Math.hypot(c.x - x, c.y - y) < 45);
                    if (castle) {
                        const current = Model.state.castles.find(c => Math.hypot(c.x - Model.state.selectedMapUnit.x, c.y - Model.state.selectedMapUnit.y) < 45);
                        if (current && current.neighbors.includes(castle.id)) {
                            Model.state.selectedMapUnit.targetX = castle.x; Model.state.selectedMapUnit.targetY = castle.y;
                            Model.state.selectedMapUnit.isMoving = true; Model.state.selectedMapUnit.hasActed = true;
                            Model.state.selectedMapUnit = null;
                            return; // ÁßªÂãï„ÇíÂÆüË°å„Åó„Åü„ÅÆ„ÅßÁµÇ‰∫Ü
                        } else {
                            View.showMessage("Èö£Êé•„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                            // Èö£Êé•„Åó„Å¶„ÅÑ„Å™„ÅÑÊã†ÁÇπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§„Åõ„Åö„ÄÅÈÉ®ÈöäÂàá„ÇäÊõø„ÅàÂà§ÂÆö„Å∏ÊµÅ„Åô„Åì„Å®„ÇÇÂèØËÉΩ„Å†„Åå„ÄÅ
                            // „Åì„Åì„Åß„ÅØ‰∏ÄÊó¶„ÇØ„É™„ÉÉ„ÇØ„ÇíÊ∂àË≤ª
                        }
                    }
                }

                // 2. Êã†ÁÇπ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØÁßªÂãï‰∏çÂèØ„Å†„Å£„ÅüÂ†¥Âêà„ÄÅÈÉ®Èöä„ÅÆÈÅ∏Êäû„ÉªÂàá„ÇäÊõø„Åà„ÇíË°å„ÅÜ
                const playerFaction = Model.state.factions.find(f => f.isPlayer);
                const clickedUnits = Model.state.mapUnits.filter(u => u.owner === playerFaction.id && !u.hasActed && Math.hypot(u.x - x, u.y - y) < 45);
                if (clickedUnits.length > 0) {
                    let nextIdx = 0;
                    if (Model.state.selectedMapUnit && clickedUnits.includes(Model.state.selectedMapUnit)) {
                        nextIdx = (clickedUnits.indexOf(Model.state.selectedMapUnit) + 1) % clickedUnits.length;
                    }
                    Model.state.selectedMapUnit = clickedUnits[nextIdx];
                } else {
                    // ‰Ωï„ÇÇ„Å™„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈÅ∏ÊäûËß£Èô§
                    Model.state.selectedMapUnit = null;
                }
            },

            handleMapRightClick(e) {
                e.preventDefault();
                if (Model.state.strategicTurn !== 'player') return;
                const rect = View.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                const clickedCastle = Model.state.castles.find(c => Math.hypot(c.x - x, c.y - y) < 45);
                if (clickedCastle) View.toggleBaseMenu(clickedCastle);
            },

            endStrategicTurn() {
                if (Model.state.strategicTurn !== 'player') return;

                const movingUnit = Model.state.mapUnits.find(u => u.owner === 'player' && u.isMoving);
                if (movingUnit) { View.showMessage("ÈÉ®Èöä„ÅåÁßªÂãï‰∏≠„Åß„Åô„ÄÇÂÆå‰∫Ü„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }

                this.startNextFactionTurn();
            },

            startNextFactionTurn() {
                const currentFactionIdx = Model.state.factions.findIndex(f => f.id === Model.state.strategicTurn);
                let nextFaction = null;
                for (let i = 1; i <= Model.state.factions.length; i++) { // Iterate through all factions, including current
                    const f = Model.state.factions[(currentFactionIdx + i) % Model.state.factions.length];
                    if (f.isAlive) {
                        nextFaction = f;
                        break;
                    }
                }

                if (!nextFaction) { // No active factions left (shouldn't happen if player is alive)
                    this.checkWinCondition();
                    return;
                }

                if (nextFaction.isPlayer) {
                    this.startPlayerTurn();
                } else {
                    this.startEnemyTurn(nextFaction.id);
                }
            },

            startEnemyTurn(factionId) {
                Model.state.strategicTurn = factionId;
                Model.state.aiActionStarted = false;

                const faction = Model.state.factions.find(f => f.id === factionId);
                if (!faction || !faction.isAlive) {
                    this.startNextFactionTurn(); // Skip if faction is defeated
                    return;
                }

                document.getElementById('turn-text').innerText = faction.name + " Turn";
                document.getElementById('turn-text').className = `text-4xl font-bold italic tracking-wider drop-shadow-[0_2px_2px_rgba(0,0,0,1)] text-white`;
                document.getElementById('turn-text').style.color = faction.color;

                document.getElementById('btn-end-strategic-turn').classList.add('hidden');
                document.getElementById('save-load-group').classList.add('hidden');

                setTimeout(() => {
                    Model.state.aiActionStarted = true;
                    const enemyCastles = Model.state.castles.filter(c => c.owner === faction.id);

                    faction.gold += (100 + enemyCastles.length * 200);

                    // 1. ÈÉ®Èöä„ÅÆÊñ∞Ë¶èÁ∑®Êàê
                    enemyCastles.forEach(castle => {
                        const unitsAtCastle = Model.state.mapUnits.filter(u => u.owner === faction.id && Math.hypot(u.x - castle.x, u.y - castle.y) < 45);
                        const totalArmies = Model.state.mapUnits.filter(u => u.owner === faction.id).length;
                        const hq = Model.state.castles.find(c => c.id === faction.hqId);

                        const needsNewArmy = (unitsAtCastle.length === 0) || (castle === hq && unitsAtCastle.length < 2);
                        if (needsNewArmy && totalArmies < Model.MAX_ARMIES && faction.gold >= Model.ARMY_COST) {
                            faction.gold -= Model.ARMY_COST;
                            Model.state.mapUnits.push({
                                id: faction.id + '-army-' + Date.now() + Math.random(),
                                owner: faction.id, x: castle.x, y: castle.y, targetX: castle.x, targetY: castle.y,
                                emoji: faction.master.emoji,
                                army: [{ ...Model.FACTION_UNITS[faction.master.id][0], currentHp: Model.FACTION_UNITS[faction.master.id][0].hp, rank: 0, xp: 0 }],
                                isMaster: false, hasActed: true, isMoving: false
                            });
                        }
                    });

                    // 2. „É¶„Éã„ÉÉ„ÉàËøΩÂä†
                    Model.state.mapUnits.filter(u => u.owner === faction.id).forEach(enemyArmy => {
                        const castle = Model.state.castles.find(c => c.owner === faction.id && Math.hypot(c.x - enemyArmy.x, c.y - enemyArmy.y) < 45);
                        if (castle) {
                            let recruitOptions = [...Model.FACTION_UNITS[faction.master.id]];
                            if (castle.uniqueUnit) recruitOptions.push(Model.SPECIAL_UNITS[castle.uniqueUnit]);
                            while (enemyArmy.army.length < Model.MAX_UNITS) {
                                const affordable = recruitOptions.filter(ut => faction.gold >= ut.cost);
                                if (affordable.length === 0) break;
                                affordable.sort((a, b) => b.cost - a.cost);
                                const unitToRecruit = Math.random() > 0.3 ? affordable[0] : affordable[Math.floor(Math.random() * affordable.length)];
                                faction.gold -= unitToRecruit.cost;
                                enemyArmy.army.push({ ...unitToRecruit, currentHp: unitToRecruit.hp, rank: 0, xp: 0 });
                            }
                        }
                    });

                    // 3. ÁßªÂãï
                    Model.state.mapUnits.filter(u => u.owner === faction.id).forEach(enemy => {
                        const current = Model.state.castles.find(c => Math.hypot(enemy.x - c.x, enemy.y - c.y) < 45);
                        if (!current) return;
                        const hq = Model.state.castles.find(c => c.id === faction.hqId);
                        const unitsAtHQ = Model.state.mapUnits.filter(u => u.owner === faction.id && Math.hypot(u.x - hq.x, u.y - hq.y) < 45);
                        if (current === hq && unitsAtHQ.length < 2 && Math.random() < 0.7) return;
                        if (unitsAtHQ.length === 0 && current.neighbors.includes(hq.id)) { enemy.targetX = hq.x; enemy.targetY = hq.y; enemy.isMoving = true; return; }

                        if (current.neighbors.length > 0 && Math.random() > 0.4) {
                            const targets = current.neighbors
                                .map(id => Model.state.castles.find(c => c.id === id))
                                .sort((a, b) => {
                                    if (a.owner !== faction.id && b.owner === faction.id) return -1;
                                    if (a.owner === 'player' && b.owner !== 'player') return -1;
                                    return 0;
                                });
                            const next = targets[0];
                            const guards = Model.state.mapUnits.filter(u => u.owner === faction.id && Math.hypot(u.x - next.x, u.y - next.y) < 45);
                            if (next.owner === faction.id && guards.length > 0 && Math.random() > 0.1) return;
                            enemy.targetX = next.x; enemy.targetY = next.y; enemy.isMoving = true;
                        }
                    });
                }, 1000);
            },

            startPlayerTurn() {
                Model.state.turnCount++;
                Model.state.strategicTurn = 'player';

                document.getElementById('turn-text').innerText = "Player Turn";
                document.getElementById('turn-text').className = "text-4xl font-bold italic tracking-wider drop-shadow-[0_2px_2px_rgba(0,0,0,1)] text-white";
                document.getElementById('turn-text').style.color = "";

                document.getElementById('btn-end-strategic-turn').classList.remove('hidden');
                document.getElementById('save-load-group').classList.remove('hidden');

                const player = Model.state.factions.find(f => f.isPlayer);
                const income = 100 + Model.state.castles.filter(c => c.owner === player.id).length * 200;
                player.gold += income;
                Model.state.mapUnits.forEach(u => u.hasActed = false);
                View.showMessage(`„Çø„Éº„É≥ÈñãÂßãÔºöÂèéÂÖ• ${income}G`);
            },

            createNewArmy(castle) {
                const player = Model.state.factions.find(f => f.isPlayer);
                if (player.gold < Model.ARMY_COST) return;
                if (Model.state.mapUnits.filter(u => u.owner === player.id).length >= Model.MAX_ARMIES) {
                    View.showMessage("ÈÉ®ÈöäÊï∞„Åå‰∏äÈôê„Å´ÈÅî„Åó„Å¶„ÅÑ„Åæ„Åô");
                    return;
                }
                player.gold -= Model.ARMY_COST;
                Model.state.mapUnits.push({ id: 'army-' + Date.now(), owner: player.id, x: castle.x, y: castle.y, targetX: castle.x, targetY: castle.y, emoji: player.master.emoji, army: [{ ...Model.FACTION_UNITS[player.master.id][0], currentHp: Model.FACTION_UNITS[player.master.id][0].hp, rank: 0, xp: 0 }], isMaster: false, hasActed: true, isMoving: false });
                View.renderBaseMenu(castle);
            },

            recruitUnit(aId, utId, cId) {
                const player = Model.state.factions.find(f => f.isPlayer);
                const army = Model.state.mapUnits.find(u => u.id === aId);
                const ut = Model.FACTION_UNITS[player.master.id].find(x => x.id === utId) || Model.SPECIAL_UNITS[utId];
                if (army && ut && army.army.length < Model.MAX_UNITS && player.gold >= ut.cost) {
                    player.gold -= ut.cost; army.army.push({ ...ut, currentHp: ut.hp, rank: 0, xp: 0 });
                    View.renderBaseMenu(Model.state.castles.find(c => c.id === cId));
                }
            },

            enhanceUnit(aId, idx, type, cId) {
                const player = Model.state.factions.find(f => f.isPlayer);
                const army = Model.state.mapUnits.find(u => u.id === aId);
                if (!army) return;
                const unit = army.army[idx];
                if (type === 'hp' && player.gold >= 100) { player.gold -= 100; unit.hp += 10; unit.currentHp += 10; }
                else if (type === 'atk' && player.gold >= 150) { player.gold -= 150; unit.atk += 3; }
                View.renderBaseMenu(Model.state.castles.find(c => c.id === cId));
            },

            startBattle() {
                window.gameState = Model.state;
                View.changeScreen('battle');
                this.initBattleGrid();
            },

            initBattleGrid() {
                const grid = document.getElementById('battle-grid'); grid.innerHTML = '';
                const cols = 7, rows = 6, hexSize = 90;
                Model.state.battle.grid = [];
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        // Ê®ôÊ∫ñÁöÑ„Å™„Éù„Ç§„É≥„Éà„Éà„ÉÉ„Éó„Éª„Éò„ÉÉ„ÇØ„Çπ„ÅÆÈÖçÁΩÆË®àÁÆó
                        const x = c * hexSize + (r % 2 ? hexSize / 2 : 0);
                        const y = r * hexSize * 0.75;
                        const hex = document.createElement('div');
                        hex.className = 'hex hex-active absolute bg-slate-800/60 border border-slate-700 flex items-center justify-center transition-all duration-200 shadow-inner';
                        hex.style.width = `${hexSize}px`; hex.style.height = `${hexSize}px`; hex.style.left = `${x}px`; hex.style.top = `${y}px`;
                        hex.onclick = () => this.handleBattleHexClick(r, c);
                        hex.oncontextmenu = (e) => { e.preventDefault(); this.handleBattleUnitRightClick(r, c); };
                        grid.appendChild(hex); Model.state.battle.grid.push({ r, c, el: hex });
                    }
                }
                grid.style.width = `${(cols + 0.5) * hexSize}px`; grid.style.height = `${(rows * 0.75 + 0.25) * hexSize}px`;
                const pU = Model.state.battleUnitA.army.map((u, i) => ({ ...u, r: 1 + i, c: 0, owner: 'player' })), eU = Model.state.battleUnitB.army.map((u, i) => ({ ...u, r: 1 + i, c: 6, owner: 'enemy' }));
                Model.state.battle.units = [...pU, ...eU]; Model.state.battle.movedUnits = new Set(); Model.state.battle.selectedUnit = null; Model.state.battle.tempMoved = false; Model.state.battle.turn = 'player'; Model.state.battle.active = true;
                View.updateBattleUI();
            },

            handleBattleHexClick(r, c) {
                const b = Model.state.battle; if (b.turn !== 'player' || !b.active) return;
                const target = b.units.find(u => u.r === r && u.c === c);
                if (b.selectedUnit && b.tempMoved) {
                    const s = b.selectedUnit; const d = Model.getHexDist(s.r, s.c, r, c);
                    if (target && target.owner === 'enemy' && d <= s.range) {
                        if (s.range > 1) View.showMessage("ÈÅ†Ë∑ùÈõ¢„ÅØÁßªÂãïÂâç„ÅÆ„Åø"); else this.battleAttack(s, target);
                    } else { b.movedUnits.add(s); b.selectedUnit = null; b.tempMoved = false; if (target && target.owner === 'player' && !b.movedUnits.has(target)) b.selectedUnit = target; }
                    View.updateBattleUI(); return;
                }
                if (target && target.owner === 'player') { if (!b.movedUnits.has(target)) { b.selectedUnit = target; b.tempMoved = false; } View.updateBattleUI(); return; }
                if (b.selectedUnit) {
                    const s = b.selectedUnit, d = Model.getHexDist(s.r, s.c, r, c);
                    if (target && target.owner === 'enemy') { if (d <= s.range) this.battleAttack(s, target); }
                    else if (!target && d <= s.move) { s.r = r; s.c = c; b.tempMoved = true; }
                    else { b.selectedUnit = null; }
                }
                View.updateBattleUI(); this.checkBattleEnd();
            },

            handleBattleUnitRightClick(r, c) {
                const b = Model.state.battle; if (!b.active) return;
                const u = b.units.find(u => u.r === r && u.c === c);
                if (u) {
                    const rank = Model.RANKS[u.rank || 0];
                    const xpText = u.rank === 5 ? "MAX" : `${u.xp || 0} / ${Model.RANK_UP_XP}`;
                    const statusText = `„Äê${u.name}„Äë (${u.owner === 'player' ? 'Ëá™Ëªç' : 'ÊïµËªç'})
 RANK: ${rank} (XP: ${xpText})
 HP: ${u.currentHp} / ${u.hp}  ATK: ${u.atk}
 RANGE: ${u.range}  MOVE: ${u.move}`;
                    View.showMessage(statusText);
                }
            },

            battleAttack(atk, def) {
                const dmg = Math.floor(atk.atk * (0.8 + Math.random() * 0.4)); def.currentHp -= dmg;
                View.showMessage(`${atk.name}„ÅÆÊîªÊíÉÔºÅ ${def.name}„Å´${dmg}„ÉÄ„É°ÔºÅ`);

                // XPÁç≤Âæó
                this.gainXp(atk, 10);

                Model.state.battle.movedUnits.add(atk); Model.state.battle.selectedUnit = null; Model.state.battle.tempMoved = false;
                if (def.currentHp <= 0) {
                    this.gainXp(atk, 30); // ÊíÉÁ†¥„Éú„Éº„Éä„Çπ
                    Model.state.battle.units = Model.state.battle.units.filter(u => u !== def);
                }
            },

            gainXp(unit, amount) {
                if (unit.rank === 5) return; // S„É©„É≥„ÇØ„ÅØÊàêÈï∑ÂÅúÊ≠¢
                if (!unit.xp && unit.xp !== 0) { unit.xp = 0; unit.rank = 0; }
                unit.xp += amount;
                if (unit.xp >= Model.RANK_UP_XP) {
                    unit.xp -= Model.RANK_UP_XP;
                    unit.rank++;

                    // ÂêÑËÉΩÂäõ„ÅÆ„Åù„ÅÆÊôÇÁÇπ„ÅÆÂÄ§„ÅÆ20%Âêë‰∏ä
                    const hpBonus = Math.max(1, Math.floor(unit.hp * 0.2));
                    const atkBonus = Math.max(1, Math.floor(unit.atk * 0.2));

                    unit.hp += hpBonus;
                    unit.currentHp += hpBonus;
                    unit.atk += atkBonus;

                    View.showMessage(`${unit.name}„Åå„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÔºÅ RANK ${Model.RANKS[unit.rank]}„Å´„Å™„Å£„ÅüÔºÅ\n(HP+${hpBonus}, ATK+${atkBonus})`);
                    if (unit.rank === 5) { unit.xp = 0; } // S„É©„É≥„ÇØÂà∞ÈÅî
                }
            },

            battleEndTurnOrder() {
                const b = Model.state.battle; if (!b.active || b.turn !== 'player') return;
                if (b.selectedUnit && b.tempMoved) b.movedUnits.add(b.selectedUnit);
                b.selectedUnit = null; b.tempMoved = false; b.turn = 'enemy'; b.movedUnits.clear();
                View.updateBattleUI(); setTimeout(() => this.enemyBattleTurn(), 800);
            },

            enemyBattleTurn() {
                const b = Model.state.battle; if (!b.active) return;
                Model.state.battle.units.filter(u => u.owner === 'enemy').forEach(e => {
                    const targets = Model.state.battle.units.filter(u => u.owner === 'player');
                    if (targets.length > 0) {
                        const t = targets[0], d = Model.getHexDist(e.r, e.c, t.r, t.c);
                        if (d <= e.range) this.battleAttack(e, t);
                        else {
                            let nR = e.r, nC = e.c;
                            if (e.r > t.r) nR--; else if (e.r < t.r) nR++;
                            if (e.c > t.c) nC--; else if (e.c < t.c) nC++;
                            if (!b.units.some(u => u.r === nR && u.c === nC)) { e.r = nR; e.c = nC; }
                            if (Model.getHexDist(e.r, e.c, t.r, t.c) <= e.range) this.battleAttack(e, t);
                            b.movedUnits.add(e);
                        }
                    }
                });
                this.checkBattleEnd();
                if (b.active) { b.turn = 'player'; b.movedUnits.clear(); View.updateBattleUI(); View.showMessage("„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥„Åß„Åô"); }
            },

            checkBattleEnd() {
                const b = Model.state.battle; if (!b.active) return;
                const pC = b.units.filter(u => u.owner === 'player').length, eC = b.units.filter(u => u.owner === 'enemy').length;
                if (eC === 0) { b.active = false; View.openModal("VICTORY", "ÂãùÂà©ÔºÅ", [{ label: "Á∂öË°å", action: () => this.finishBattle(true) }]); }
                else if (pC === 0) { b.active = false; View.openModal("ÊïóÂåó", "ÂÖ®ÊªÖ„Åó„Åü...", [{ label: "Â∏∞ÈÇÑ", action: () => this.finishBattle(false) }]); }
            },

            autoResolveBattle(u1, u2) {
                const p1 = u1.army.reduce((sum, unit) => sum + unit.atk, 0) * (u1.army.length / 5 + 0.5);
                const p2 = u2.army.reduce((sum, unit) => sum + unit.atk, 0) * (u2.army.length / 5 + 0.5);

                // ‰∏°Ëªç„Å´„ÉÄ„É°„Éº„Ç∏
                u1.army.forEach(u => u.currentHp -= Math.floor(p2 / u1.army.length * (0.5 + Math.random())));
                u2.army.forEach(u => u.currentHp -= Math.floor(p1 / u2.army.length * (0.5 + Math.random())));

                u1.army = u1.army.filter(u => u.currentHp > 0);
                u2.army = u2.army.filter(u => u.currentHp > 0);

                u1.army.forEach(u => u.currentHp -= Math.floor(p2 / u1.army.length * (0.5 + Math.random())));
                u2.army.forEach(u => u.currentHp -= Math.floor(p1 / u2.army.length * (0.5 + Math.random())));

                u1.army = u1.army.filter(u => u.currentHp > 0);
                u2.army = u2.army.filter(u => u.currentHp > 0);

                const f1 = Model.state.factions.find(f => f.id === u1.owner);
                const f2 = Model.state.factions.find(f => f.id === u2.owner);

                if (u1.army.length === 0 && u2.army.length === 0) {
                    View.showMessage(`ÊøÄÊà¶„ÅÆÊú´„ÄÅ${f1.name}„Å®${f2.name}„ÅØÁõ∏Êâì„Å°„Å®„Å™„ÇäÂÖ±„Å´Ê∂àÊªÖ„Åó„Åæ„Åó„ÅüÔºÅ`);
                    Model.state.mapUnits = Model.state.mapUnits.filter(u => u !== u1 && u !== u2);
                } else if (u1.army.length === 0) {
                    View.showMessage(`${f1.name}„ÅØÊïóÂåó„Åó„ÄÅ${f2.name}„ÅåÂãùÂà©„Åó„Åæ„Åó„ÅüÔºÅ`);
                    Model.state.mapUnits = Model.state.mapUnits.filter(u => u !== u1);
                } else if (u2.army.length === 0) {
                    View.showMessage(`${f2.name}„ÅØÊïóÂåó„Åó„ÄÅ${f1.name}„ÅåÂãùÂà©„Åó„Åæ„Åó„ÅüÔºÅ`);
                    Model.state.mapUnits = Model.state.mapUnits.filter(u => u !== u2);
                } else {
                    View.showMessage(`${f1.name}„Å®${f2.name}„ÅÆÂ∞èÁ´∂„ÇäÂêà„ÅÑ„ÅåÁô∫Áîü„Åó„Åæ„Åó„ÅüÔºÅ`);
                }

                Model.state.globalBattleCooldown = 40;

                // „Éê„Éà„É´„ÅåÁô∫Áîü„Åó„ÅüÂ†¥ÊâÄ„ÅåÊã†ÁÇπ„Å™„Çâ„ÄÅÊïóÂåó„Åó„ÅüÂÅ¥„ÅÆ„É¶„Éã„ÉÉ„Éà„ÅåÊ∂àÊªÖ„Åó„ÅüÂæå„Å´Êã†ÁÇπ„ÅÆÂà∂Âúß„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂëº„Å∂ÂøÖË¶Å„Åå„ÅÇ„Çã
                // updateLogic„ÅÆ„É°„Ç§„É≥„É´„Éº„Éó„ÅßÂà§ÂÆö„Åï„Çå„Çã„Åå„ÄÅÂç≥ÊôÇ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂá∫„Åô„Åü„ÇÅ„Å´„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„ÇãÁ≠â„ÅÆÂá¶ÁêÜ„ÅØ‰∏çË¶Å
            },

            finishBattle(win) {
                const pA = Model.state.battleUnitA;
                pA.hasActed = true; // Êà¶ÈóòÁµÇ‰∫ÜÂæå„Å´Ë°åÂãïÊ∏à„Åø„Å®„Åô„Çã
                if (win) {
                    Model.state.mapUnits = Model.state.mapUnits.filter(u => u !== Model.state.battleUnitB);
                    // Áîü„ÅçÊÆã„Å£„Åü„É¶„Éã„ÉÉ„Éà„ÇíÂÖ®ÂõûÂæ©„Åï„Åõ„Å¶Âºï„ÅçÁ∂ô„Åê
                    pA.army = Model.state.battle.units.filter(u => u.owner === 'player').map(u => ({ ...u, currentHp: u.hp }));
                } else {
                    // Êú¨Êã†Âú∞ÔºàHQÔºâ„Åß„ÅÆÊïóÂåó„ÉªÊí§ÈÄÄ„ÅØÂç≥Â∫ß„Å´„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
                    const castleAtPos = Model.state.castles.find(c => Math.hypot(pA.x - c.x, pA.y - c.y) < 45);
                    const playerFaction = Model.state.factions.find(f => f.isPlayer);
                    const atHQ = castleAtPos && castleAtPos.id === playerFaction.hqId;

                    if (atHQ) {
                        Model.state.gameCleared = true;
                        View.showEnding(false);
                        return;
                    }

                    // ÊïóÂåóÊôÇ„ÅØ„Éö„Éä„É´„ÉÜ„Ç£„Å®„Åó„Å¶ÂàùÊúü„É¶„Éã„ÉÉ„Éà1‰Ωì„ÅßÂæ©Ê¥ªÔºàHPÂÖ®ÈñãÔºâ
                    pA.army = [{ ...Model.FACTION_UNITS[playerFaction.master.id][0], currentHp: Model.FACTION_UNITS[playerFaction.master.id][0].hp, rank: 0, xp: 0 }];
                    const hq = Model.state.castles.find(c => c.id === playerFaction.hqId);
                    if (hq) {
                        // „ÇÇ„ÅóÊú¨Êã†Âú∞„ÅåÊó¢„Å´Êïµ„Å´Âç†È†ò„Åï„Çå„Å¶„ÅÑ„Åü„ÇâÊïóÂåó
                        if (hq.owner !== playerFaction.id) {
                            Model.state.gameCleared = true;
                            View.showEnding(false);
                            return;
                        }
                        pA.x = hq.x; pA.y = hq.y; pA.targetX = hq.x; pA.targetY = hq.y;
                    }
                }
                Model.state.globalBattleCooldown = 60; Model.state.battle.active = false; View.changeScreen('map');
            },

            showEscapeConfirm() { View.openModal("Êí§ÈÄÄÁ¢∫Ë™ç", "Êà¶Â†¥„Åã„ÇâÈõ¢ËÑ±„Åó„Åæ„Åô„ÅãÔºü", [{ label: "„ÅØ„ÅÑ", action: () => this.finishBattle(false) }, { label: "„ÅÑ„ÅÑ„Åà", action: () => { } }]); },

            saveGame() {
                const saveState = JSON.parse(JSON.stringify(Model.state));
                saveState.battle.grid = [];
                if (Model.state.battle.movedUnits) {
                    saveState.battle.movedUnitsIndices = [...Model.state.battle.movedUnits].map(u => Model.state.battle.units.indexOf(u));
                }
                localStorage.setItem('bahamut_save', JSON.stringify(saveState));
                View.showMessage("„Ç∑„Çπ„ÉÜ„É†ÔºöÈÄ≤Ë°åÁä∂Ê≥Å„Çí„Çª„Éº„Éñ„Åó„Åæ„Åó„Åü");
            },

            loadGame() {
                const data = localStorage.getItem('bahamut_save');
                if (!data) { View.showMessage("„Ç®„É©„ÉºÔºö„Çª„Éº„Éñ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"); return; }
                const state = JSON.parse(data);
                if (state.battle.movedUnitsIndices) {
                    state.battle.movedUnits = new Set(state.battle.movedUnitsIndices.map(i => state.battle.units[i]));
                } else {
                    state.battle.movedUnits = new Set();
                }
                Model.state = state;
                View.changeScreen(Model.state.currentScreen);
                if (Model.state.currentScreen === 'map') {
                    View.initCanvas();
                } else if (Model.state.currentScreen === 'battle') {
                    this.initBattleGrid();
                }
                const player = Model.state.factions.find(f => f.isPlayer);
                if (player) {
                    document.getElementById('master-name').innerText = player.master.name;
                    document.getElementById('master-name').style.color = player.master.color;
                    document.getElementById('master-alignment').innerText = player.master.alignment;
                }
                const turns = Model.state.strategicTurn !== 'player';
                document.getElementById('turn-text').innerText = turns ? (Model.state.factions.find(f => f.id === Model.state.strategicTurn)?.name + " Turn") : "Player Turn";
                document.getElementById('turn-text').classList.toggle('text-red-500', turns);
                document.getElementById('btn-end-strategic-turn').classList.toggle('hidden', turns);
                document.getElementById('save-load-group').classList.toggle('hidden', turns);
                View.showMessage("„Ç∑„Çπ„ÉÜ„É†Ôºö„Ç≤„Éº„É†„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü");
            }
        };

        /**
         * TEST SUITE: „Ç∑„Çπ„ÉÜ„É†„ÉÜ„Çπ„Éà
         */
        const TestSuite = {
            logs: [],
            assert(condition, message) {
                this.logs.push(`${condition ? '‚úÖ PASS' : '‚ùå FAIL'}: ${message}`);
                return condition ? 1 : 0;
            },

            runAll() {
                this.logs = [];
                let passed = 0, total = 0;

                console.log("--- Starting System Tests ---");

                // ÂÆüË°åÂâç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
                const originalFactions = JSON.parse(JSON.stringify(Model.state.factions));
                const originalUnits = [...Model.state.mapUnits];
                const originalCastles = JSON.parse(JSON.stringify(Model.state.castles));

                // ÈÄ≤Ë°åÁä∂ÊÖã„Åß„Å™„Åë„Çå„Å∞„ÉÜ„Çπ„ÉàÁî®„Å´ÊúÄÂ∞èÈôê„ÅÆÂàùÊúüÂåñ„ÇíË°å„ÅÜ
                if (Model.state.factions.length === 0) {
                    Model.state.factions = [
                        { id: 'player', name: 'Ëá™Ëªç', gold: 500, master: Model.MASTERS[0], color: '#44aaff', isPlayer: true, isAlive: true, hqId: 'c1' },
                        { id: 'enemy', name: 'ÊïµËªç', gold: 500, master: Model.MASTERS[1], color: '#ff4444', isPlayer: false, isAlive: true, hqId: 'c2' }
                    ];
                }

                // 1. Ë∑ùÈõ¢Ë®àÁÆó„ÅÆ„ÉÜ„Çπ„Éà
                total++; passed += this.assert(Model.getHexDist(0, 0, 0, 1) === 1, "Hex Distance: Adjacent");
                total++; passed += this.assert(Model.getHexDist(0, 0, 2, 2) === 3, "Hex Distance: Diagonal (0,0 to 2,2 is 3 steps)");
                total++; passed += this.assert(Model.getHexDist(0, 0, 5, 0) === 5, "Hex Distance: Far");

                // 2. Â∫ßÊ®ôÂ§âÊèõ„ÅÆ„ÉÜ„Çπ„Éà
                const cube = Model.getCubeCoords(2, 2);
                total++; passed += this.assert(cube.x + cube.y + cube.z === 0, "Cube Coordinates: Sum is zero");

                // 3. Ë≥áÈáëÁÆ°ÁêÜ„Å®ÈõáÁî®Âà∂Èôê„ÅÆ„ÉÜ„Çπ„Éà
                const player = Model.state.factions.find(f => f.isPlayer);
                if (!player) { View.showMessage("„ÉÜ„Çπ„ÉàÂ§±Êïó: „Éó„É¨„Ç§„É§„ÉºÂã¢Âäõ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"); return; }

                // „É¢„ÉÉ„ÇØ„Éá„Éº„ÇøË®≠ÂÆö
                player.master = Model.MASTERS[0]; // knight
                player.gold = 400; // 500GÊú™Ê∫Ä„Å´Ë®≠ÂÆö
                const mockCastle = { x: 0, y: 0, id: 'test-c' };

                Controller.createNewArmy(mockCastle);
                total++; passed += this.assert(Model.state.mapUnits.length === originalUnits.length, "Create Army: Should fail if insufficient gold");

                player.gold = 1000;
                Controller.createNewArmy(mockCastle);
                total++; passed += this.assert(Model.state.mapUnits.length === originalUnits.length + 1, "Create Army: Should succeed if enough gold");
                total++; passed += this.assert(player.gold === 500, "Create Army: Gold should be deducted");

                // ÊúÄÂ§ßÈÉ®ÈöäÊï∞Âà∂Èôê„ÅÆ„ÉÜ„Çπ„Éà
                player.gold = 10000;
                while (Model.state.mapUnits.length < Model.MAX_ARMIES) { Controller.createNewArmy(mockCastle); }
                const countBefore = Model.state.mapUnits.length;
                Controller.createNewArmy(mockCastle);
                total++; passed += this.assert(Model.state.mapUnits.length === countBefore, "Create Army: Should not exceed MAX_ARMIES");

                // 4. ÂèéÂÖ•Ë®àÁÆó„ÅÆ„ÉÜ„Çπ„Éà
                player.gold = 0;
                Model.state.castles = [
                    { owner: 'player' }, { owner: 'player' }, { owner: 'enemy' }
                ];
                Controller.startPlayerTurn();
                // 100(Âü∫Êú¨) + 2(ÂüéÊï∞) * 200 = 500
                total++; passed += this.assert(player.gold === 500, `Income Calculation: Expected 500, got ${player.gold}`);

                // 5. ÂãùÂà©„ÉªÊïóÂåóÂà§ÂÆö„ÅÆ„ÉÜ„Çπ„Éà
                Model.state.gameCleared = false;
                // ÂÖ®„Å¶„ÅÆÊïµÂã¢Âäõ„ÇíÊªÖ‰∫°„Åï„Åõ„Çã
                Model.state.factions.forEach(f => { if (!f.isPlayer) f.isAlive = false; });
                Controller.checkWinCondition();
                total++; passed += this.assert(Model.state.gameCleared === true, "Win Condition: All enemies are dead");

                Model.state.gameCleared = false;
                Model.state.factions.forEach(f => { if (!f.isPlayer) f.isAlive = true; });
                Model.state.castles = [{ owner: 'enemy' }, { owner: 'neutral' }]; // Ëá™ËªçÊã†ÁÇπ„Åå0
                Controller.checkWinCondition();
                total++; passed += this.assert(Model.state.gameCleared === true, "Lose Condition: Player castles are zero");

                // 6. „Çø„Éº„É≥„É™„Çª„ÉÉ„Éà„Å®Ë°åÂãï„Éï„É©„Ç∞„ÅÆ„ÉÜ„Çπ„Éà
                const mockArmy = { hasActed: false, owner: 'player', x: 0, y: 0, targetX: 0, targetY: 0, army: [] };
                Model.state.battleUnitA = mockArmy;
                Model.state.battleUnitB = { owner: 'enemy', army: [] };
                Controller.finishBattle(true);
                total++; passed += this.assert(mockArmy.hasActed === true, "Action Flag: Unit should be 'acted' after battle");

                // „Çø„Éº„É≥ÈñãÂßãÊôÇ„ÅÆ„É™„Çª„ÉÉ„Éà„ÉÜ„Çπ„Éà
                Model.state.mapUnits = [
                    { hasActed: true, owner: 'player' },
                    { hasActed: true, owner: 'player' },
                    { hasActed: false, owner: 'enemy' }
                ];
                Controller.startPlayerTurn();
                total++; passed += this.assert(Model.state.mapUnits[0].hasActed === false, "Turn Reset: Player unit 1 should be reset");
                total++; passed += this.assert(Model.state.mapUnits[1].hasActed === false, "Turn Reset: Player unit 2 should be reset");

                // Áí∞Â¢É„ÅÆÂæ©ÂÖÉ
                Model.state.factions = originalFactions;
                Model.state.mapUnits = originalUnits;
                Model.state.castles = originalCastles;
                Model.state.gameCleared = false;
                Model.state.battleUnitA = null;
                Model.state.battleUnitB = null;

                // ÁµêÊûú„ÅÆË°®Á§∫
                this.logs.forEach(log => console.log(log));
                console.log(`--- Test Results: ${passed}/${total} passed ---`);
                View.showMessage(`„ÉÜ„Çπ„ÉàÂÆå‰∫Ü: ${passed}/${total} ÂêàÊ†º„ÄÇË©≥Á¥∞„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            }
        };

        window.onload = () => { Controller.init(); View.changeScreen('title'); };
        window.onresize = () => { if (Model.state.currentScreen === 'map') View.initCanvas(); };
    </script>
</body>

</html>